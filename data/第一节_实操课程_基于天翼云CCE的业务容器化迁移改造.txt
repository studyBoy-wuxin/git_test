基于天翼云CCE的业务容器化迁移改造课程开发第6小组瞿润萍、胡晓宇、陈悦、马嘉希、杜伟、胡琛课程介绍

1.云网支撑工程师

2.产品支撑经理

3.客户工程师

4.解决方案经理

5.云网工程师

6.产数工程师学员对象学习目标•理解天翼云容器引擎•掌握应用容器部署CCE实战•熟悉容器化部署后运维能力目录

第一章.天翼云容器引擎CCE

第二章.应用容器部署CCE实战

第三章.容器化部署后运维能力提升

第一章•第一节云容器引擎&集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他4云容器引擎产品架构5•基于天翼云的计算、存储、网络等基础资源，搭载容器引擎集群•兼容标准k8s版本，可以通过k8s的OpenAPI调用产品能力•为应用提供监控、日志、负载均衡、弹性伸缩、镜像仓库等基础能力•提供标准界面，支持用户通过控制台进行图形化操作，帮助用户快速部署和运维分布式应用•支持Docker镜像，提供公共镜像，也支持用户使用自定义镜像部署各类自有业务•支持用户集成各类第三方插件，以扩充容器平台能力集群管理——集群概述6集群优势随着应用程序开发向基于容器的方向发展，编排和管理资源的需求变得越来越重要。Kubernetes是一个开源的、功能强大的容器编排系统，用于管理容器化应用和服务，它提供了应用部署、规划、更新、维护的一种机制，让部署容器化的应用更加简单并且高效。云容器引擎（CloudContainerEngine，以下简称CCE）是一种托管的Kubernetes服务，可进一步简化基于容器的应用程序部署和管理，可以在CCE中方便的创建Kubernetes集群、部署您的容器化应用，以及方便的管理和维护。传统的应用部署方式是通过插件或脚本来安装应用。这样做的缺点是应用的运行、配置、管理、所有生存周期将与当前操作系统绑定，这样做并不利于应用的升级更新/回滚等操作，当然也可以通过创建虚拟机的方式来实现某些功能，但是虚拟机非常重，并不利于可移植性。新的方式是通过部署容器方式实现，每个容器之间互相隔离，每个容器有自己的文件系统，容器之间进程不会相互影响，能区分计算资源。相对于虚拟机，容器能快速部署，由于容器与底层设施、机器文件系统解耦的，所以它能在不同云、不同版本操作系统间进行迁移。容器占用资源少、部署快，每个应用可以被打包成一个容器镜像，每个应用与容器间成一对一关系也使容器有更大优势，使用容器可以在build或release的阶段，为应用创建容器镜像，因为每个应用不需要与其余的应用堆栈组合，也不依赖于生产环境基础结构，这使得从研发到测试、生产能提供一致环境。类似地，容器比虚拟机轻量、更“透明”，这更便于监控和管理。集群（Cluster）是容器运行所需云资源的集合，包含了若干云服务器节点（物理服务器或者虚拟机）、负载均衡、虚拟私有云等云资源，您可以在集群中运行您的应用程序。在CCE中，我们可以创建若干集群，每个集群可以创建多个容器，每个容器里面运行一个应用实例，然后通过内置的负载均衡策略，实现对这一组应用实例的管理、发现、访问，而这些细节都不需要运维人员去进行复杂的手工配置和处理。集群管理——集群概述7集群架构CCE集群类型CCE采用兼容标准的Kubernetes集群，Kubernetes集群属于主从分布式架构，主要由Master和WorkerNode组成，以及包括客户端命令行工具kubectl和其它附加项。因此，在CCE集群中至少包含一个Master和多个WorkerNode，这些WorkerNode称为工作节点，这些节点都运行在Kubernetes集群编排系统中。云容器引擎CCE深度整合高性能的计算、网络、存储等服务，支持多可用区（Availablezone，简称AZ）容灾等技术构建高可用Kubernetes集群。CCE已支持创建Kubernetes集群。混合集群：支持虚拟机与裸金属服务器、GPU虚拟机等异构节点的混合部署，基于高性能网络模型提供全方位、多场景、安全稳定的容器运行环境。集群管理——集群生命周期8集群状态及说明状态说明创建中集群正在创建，正在申请云资源正常集群正常运行扩容中集群正在增加节点缩容中集群正在删除节点休眠中集群正在休眠中唤醒中集群正在唤醒中升级中集群正在升级中不可用当前集群不可用删除中集群正在删除中集群管理——购买云容器引擎9集群管理——购买云容器引擎10集群管理——购买云容器引擎11集群管理——购买云容器引擎12集群管理——购买云容器引擎13集群管理——购买云容器引擎14集群管理——购买云容器引擎15集群管理——查看API16集群管理——kubectl访问集群17背景信息若您需要从客户端计算机连接到kubernetes集群，请使用kubernetes命令行客户端kubectl。前提条件CCE支持“VPC网络内访问”和“互联网访问”两种方式访问集群。•VPC网络内访问：您需要在ECS控制台购买一台云服务器，并确保和当前集群在同个VPC内。•互联网访问：您需要准备一台能连接公网的云服务器。须知：通过“互联网访问”方式访问集群，集群的kube-apiserver将会暴露到互联网，存在被攻击的风险，建议对kube-apiserver所在节点的EIP配置DDoS高防服务。下载kubectl您需要先下载kubectl以及配置文件，拷贝到您的客户端机器，完成配置后，即可以使用访问kubernetes集群。请进入Kubernetes网站进行下载（https://kubernetes.io/docs/tasks/tools/）下载与集群版本对应的或者更新的kubectl。集群管理——kubectl访问集群18下载kubectl配置文件请点击此处下载（公网apiserver地址变更后请重新下载）安装和配置kubectl以下操作以linux环境为例kubeconfig.json

1.拷贝kubectl及其配置文件到您客户端机器的/home目录下

2.登录到您的客户端机器，配置kubectlcd/homechmod+xkubectlmv-fkubectl/usr/local/binmkdir-p$HOME/.kubemv-fkubeconfig.json$HOME/.kube/config

3.根据使用场景，按需切换kubectl的访问模式●VPC网络内接入访问请执行此命令kubectlconfiguse-contextinternal●互联网接入访问请执行此命令（需绑定公网apiserver地址）kubectlconfiguse-contextexternal

4.设置完成后，可以通过以下命令查看kubernetes集群信息kubectlcluster-info集群管理——集群弹性扩容19操作场景通过云容器引擎管理控制台，您可以根据实际业务需要对集群的工作节点进行扩容和缩容，当集群中出现由于资源不足而无法调度的工作负载时自动触发扩容，从而减少人力成本。约束与限制该功能仅支持通过按需计费方式购买的虚拟机节点，不支持“包年/包月”方式购买的节点和裸金属节点。目前不支持集群中Master节点的扩容和缩容。集群管理——集群升级20当某个集群版本支持升级能力后，您可以随时进行升级操作。您可以在CCE控制台中确认您的集群是否可以进行升级操作，确认方法：单击“资源管理>集群管理”，查看待升级集群右上角是否存在“可升级”提示，若存在则该集群支持升级，若不存在，则该集群不支持升级。注意事项当前仅支持虚拟机节点的CCE集群升级。集群升级时若需要升级CoreDNS插件，请确保节点数大于等于CoreDNS的实例数，且CoreDNS的所有实例都处于运行状态，否则将导致升级失败。

1.13版本的集群若需升级到更高版本，需先将CoreDNS插件升级当前集群可用的最新版本。集群升级路径如下表格详细介绍了各集群版本能够升级到的目标版本，以及升级方式和升级影响。源版本目标版本升级方式升级影响v

1.15v

1.17滚动升级重置升级•不再支持Flexvolume（storage-driver）存储类型。•升级集群前需要将存储类型由Flexvolume（storage-driver）转换为CSI（Everest）存储类型。v

1.13v

1.15滚动升级重置升级•coredns配置中proxy配置项不支持，需要替换成forword。•存储插件从原来的storage-driver替换成了Everest。大版本升级说明升级前版本目标版本说明v

1.15v

1.17支持在Console中将v

1.15升级到v

1.17。社区v

1.15与v

1.17版本之间的CHANGELOGv

1.16到v

1.17的变化：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-

1.

17.mdv

1.15到v

1.16的变化：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-

1.

16.md在CCE所创的集群中，Kubernetesv

1.

15.11版本是Flexvolume插件（storage-driver）被CSI插件（Everest）兼容接管的过渡版本，v

1.17及之后版本的集群中将彻底去除对Flexvolume插件的支持，请您将Flexvolume插件的使用切换到CSI插件上。v

1.13v

1.15暂不支持在Console中将v

1.13升级到v

1.15，您可以通过提交工单申请升级。集群升级到新版本后，不支持回退到老版本。社区v

1.13与v

1.15版本之间的CHANGELOGv

1.14到v

1.15的变化：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-

1.

15.mdv

1.13到v

1.14的变化：https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-

1.

14.mdv

1.

13.11-r1升级到v

1.

15.11-r1版本的集群后，原v

1.13的fuxiFlexvolume（即storage-driver插件）容器存储由v

1.15的CSI（即Everest插件，插件版本v

1.

1.6及以上）接管，原有功能保持不变，但请注意不要新建fuxiFlexvolume的存储，否则将导致部分存储功能异常。集群管理——集群跨版本业务迁移21适用场景本章介绍在CCE中如何将老版本集群的业务迁移到新版本集群。适用于需要大幅度跨版本集群升级的需求，可以接受新建新版本集群而进行业务迁移的升级方式。前提条件迁移前Checklist类别描述集群相关Nodeip强相关：确认之前集群的节点IP（包括EIP），是否有作为其他的配置或者白名单之类的设置。工作负载记录工作负载数目，便于迁移后检查。存储

1.确认应用中存储，是否使用公有云，或者自己搭建存储。

2.自动创建的存储需要在新集群中变成使用已有存储。网络

1.注意使用的负载均衡服务，以及Ingress。

2.老版本的集群只支持经典型负载均衡服务，迁移到新集群中需要改成共享型负载均衡服务，对应负载均衡服务将会重新建立。运维私有配置：确认在之前集群中，是否在节点上配置内核参数或者系统配置。操作步骤步骤1创建新集群创建与老版本集群同规格同配置的集群，创建方法请参见购买混合集群。步骤2添加节点添加同规格节点，并且在节点上配置之前的手动配置项，创建方法请参见购买节点。步骤3创建存储在新集群中使用已有存储创建PVC，PVC名称不变，方法请参见存储管理->使用kubectl对接已有云硬盘。说明：切流方案仅支持对象存储、文件存储、共享云硬盘类型的存储。非共享云硬盘存储切流需要将老集群内的工作负载暂停，会导致断服。步骤4创建工作负载在新集群中创建工作负载，名称和规格参数保持不变，创建方法请参见工作负载管理->创建无状态负载(Deployment)或创建有状态负载(StatefulSet)。在工作负载中挂载存储，方法请参见存储管理->使用kubectl部署带云硬盘存储卷的工作负载。步骤5创建服务在新集群中创建Service，名称和规格参数保持不变，创建方法请参见网络管理->集群内访问(ClusterIP)、节点访问(NodePort)、负载均衡(LoadBalancer)。步骤6调测功能全部创建完成后，请自行调测业务，调测无问题后切换流量。步骤7老集群退订或删除新集群全部功能ready，使用解关联功能卸载存储关联卷，方法请参见存储管理->解关联云硬盘。退订或者删除老集群集群管理——删除集群22须知删除集群会将集群内的节点以及运行的业务与应用全部销毁，请谨慎操作。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>集群管理”。步骤2单击待删除集群后的“更多>删除集群”。步骤3在弹出的“删除集群”窗口中，根据系统提示进行删除操作。步骤4单击“是”，开始执行删除集群操作。说明删除集群会将集群内的节点（纳管节点和包周期节点除外）以及运行的工作负载和服务都销毁。删除集群需要花费1~3分钟，请耐心等候。请在窗口下方的输入框中输入DELETE以确认删除此集群。集群不可用时删除集群，存储会残留。集群版本为v

1.

13.10及之前版本时，请勿在ELB服务手动修改监听器名称和后端服务器名称，否则删除集群会有资源残留。集群管理——集群休眠与唤醒23集群休眠操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>集群管理”。步骤2单击待休眠集群后的“更多>集群休眠”。步骤3在弹出的集群休眠提示框中，查看风险提示，单击“是”，等待集群完成休眠。须知：按需付费集群休眠后，将暂停收取控制节点资源费用。集群休眠后，集群所属的工作节点（ECS）、绑定的弹性IP、带宽等资源仍将按各自的计费方式进行收费。如需关机节点，请在集群休眠提示框中勾选“关机集群下所有节点”或参见节点关机。步骤4当集群状态由“休眠中”变为“休眠”时，即完成休眠操作。集群唤醒操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>集群管理”。步骤2单击待唤醒集群后的“更多>集群唤醒”。步骤3在弹出的集群唤醒提示框中，单击“是”，等待集群完成唤醒。步骤4当集群状态由“唤醒中”变为“正常”时，即完成唤醒操作。说明：集群唤醒后，将继续收取控制节点资源费用。操作场景暂时不需要使用集群时，为节省集群管理费用，建议您将集群设置为休眠状态。集群休眠后，将无法在此集群上创建和管理工作负载等资源。休眠中的集群可以快速唤醒，正常使用。集群管理——获取集群证书24操作场景通过控制台获取集群证书，使用该证书可以访问Kubernetes。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>集群管理”。步骤2在集群列表页面中，单击对应集群后的“更多>证书获取”。步骤3在弹出的“证书获取”窗口中，根据系统提示下载集群X509证书。后期访问Kubernetes时需要加载此证书。须知下载的证书包含client.key、client.crt、ca.crt三个文件，请妥善保管您的证书，不要泄露。集群中容器之间互访不需要证书。集群管理——集群监控25操作场景云容器引擎与监控服务（CloudEye）无缝集成，您可以实时查看每个集群控制节点的资源使用情况，了解CCE集群控制节点的监控指标，及时收到异常告警并做出反应，保证业务顺畅运行。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>集群管理”。步骤2单击待监控的集群名称，进入集群详情。步骤3单击“更多”右侧的图标，可以查看集群资源监控详情。步骤4单击控制节点右侧的“监控”链接，可进入应用运维管理控制台，在“主机监控”中查看对应控制节点的基本监控信息，包括CPU使用率、物理内存使用率、磁盘使用率等指标。集群管理——集群管理权限控制26操作场景若需要对集群中的资源进行权限控制，（例如A用户只能对某个命名空间下的应用有读写权限，B用户只能对集群下的资源有读权限等），请参照本章节操作。操作步骤步骤1若需要对集群进行权限控制，请在创建集群时的“认证方式”参数后勾选“认证能力增强”，选择“认证代理”。单击“CA根证书”后的“上传文件”，上传符合规范且合法的证书。步骤2通过kubectl创建角色。步骤3通过kubectl创建角色绑定。步骤4创建角色并与用户绑定成功后，请在接口请求的headers中携带用户信息以及集群创建时上传的证书访问kubernetes接口。说明CCE支持天翼云帐号和IAM用户分别下载config文件（kubeconfig.json），IAM用户下载的config文件只有30天的有效期，而天翼云帐号下载的config文件会长期有效。该文件用户对接认证用户集群，请用户妥善保存该认证凭据，防止文件泄露后，集群有被攻击的风险。如果不幸泄露，可以通过证书更新的方式，替换认证凭据。IAM用户下载的config文件所拥有的Kubernetes权限与CCE控制台上IAM用户所拥有的权限一致。另外，还支持X-Remote-Group的头域：用户组名，在做RoleBinding时，可以将Role与Group进行绑定，并在访问集群时携带用户组信息。

第一章•第一节集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他27节点管理——节点概述28简介节点是容器集群组成的基本元素。节点取决于业务，既可以是虚拟机，也可以是物理机。每个节点都包含运行Pod所需要的基本组件，包括Kubelet、Kube-proxy、ContainerRuntime等。说明：CCE创建的Kubernetes集群包含master节点和node节点，本章讲述的节点特指node节点，node节点是集群的计算节点，即运行容器化应用的节点。在云容器引擎CCE中，主要采用高性能的弹性云主机作为节点来构建高可用的Kubernetes集群。注意事项为了保证节点的稳定性，CCE集群节点上会根据节点的规格预留一部分资源给Kubernetes的相关组件（kubelet、kube-proxy以及docker等）和Kubernetes系统资源，使该节点可作为您的集群的一部分。因此，您的节点资源总量与节点在Kubernetes中的可分配资源之间会存在差异。节点的规格越大，在节点上部署的容器可能会越多，所以Kubernetes自身需预留更多的资源。节点的网络（如虚机网络、容器网络等）均被CCE接管，不允许用户自行添加网卡或改变路由，若自行修改，CCE不保证服务可用。节点购买后如需对其进行升级或降低规格等操作，请将节点关机后进行变更，也可以重新购买节点后，将老节点删除。节点生命周期生命周期是指节点从创建到删除（或释放）历经的各种状态。状态状态属性说明可用稳定状态节点正常运行状态，并连接上集群。在这个状态的节点可以运行您的业务。不可用稳定状态节点运行异常状态。在这个状态下的实例，不能对外提供业务，需要重置节点或联系管理员进行处理。创建中中间状态创建节点实例后，在节点状态进入运行中之前的状态。安装中中间状态节点处于安装Kubernetes软件的过程中。删除中中间状态节点处于正在被删除的状态。如果长时间处于该状态，则说明出现异常，需要联系管理员处理。关机稳定状态节点被正常停止。在这个状态下的实例，不能对外提供业务，您可以在弹性云主机列表页对其进行开机操作。错误稳定状态节点处于异常状态。在这个状态下的实例，不能对外提供业务，需要重置节点或联系管理员进行处理。节点管理——购买节点29操作场景节点是指纳管到容器集群的计算资源，包括虚拟机、物理机等。用户需确保所在集群的节点资源充足，若节点资源不足，会导致创建工作负载等操作失败。前提条件已创建至少一个集群。需要新建一个密钥对，用于远程登录节点时的身份认证。说明：若使用密码登录节点，请跳过此操作。约束与限制仅支持创建KVM虚拟化类型的节点，非KVM虚拟化类型的节点创建后无法正常使用。集群中的节点一旦购买后不可变更可用区。集群中通过“按需计费”模式购买的节点，在CCE“节点管理”中进行删除操作后将会直接被删除；通过“包年/包月”模式购买的节点不能直接删除，请通过页面右上角用户名称下的“我的订单”执行资源退订操作。进入购买方式可通过如下两种方式进入“购买节点”页面：在左侧导航栏中选择“资源管理>节点管理”，选择节点所在的集群后，在节点列表页面单击上方的“购买节点”。在左侧导航栏中选择“资源管理>集群管理”，在集群卡片上，单击“购买节点”。节点管理——纳管已有节点到集群30操作场景CCE集群支持两种添加节点的方式：购买节点和纳管节点，纳管节点是指将“已购买的弹性云主机（ECS）加入到CCE集群中”，所纳管节点的计费模式支持“按需计费”和“包年/包月”两种类型。本节将指导您通过CCE控制台纳管已有虚拟机节点。须知：•纳管时，会将所选弹性云主机的操作系统重置为CCE提供的标准镜像，以确保节点的稳定性，请选择操作系统及重置后的登录方式。•所选弹性云主机挂载的系统盘、数据盘都会在纳管时被格式化，请确保信息已备份。•纳管过程中，请勿在弹性云主机控制台对所选虚拟机做任何操作。约束与限制•目前仅支持在CCE集群中纳管同一Region下的虚拟机节点（含GPU加速型）。•集群版本需V

1.13及以上。•集群开启IPv6后，只支持纳管所在的子网开启了IPv6功能的节点；集群未开启IPv6，只支持纳管所在的子网未开启IPv6功能的节点。•原虚拟机节点创建时若已设置密码或密钥，需等待虚拟机节点可用10分钟后方可纳管。前提条件支持纳管符合如下条件的弹性云主机：•待纳管节点已购买成功，且必须状态为“运行中“，且未被其他集群所使用。•纳管节点需与CCE集群在同一虚拟私有云内（若集群版本低于

1.

13.10，纳管节点还需要与CCE集群在同一子网内）。•需挂载数据盘，数据盘需满足有且仅有1块，且容量不少于100GB，多余的数据盘请先卸载。•节点规格要求：CPU必须2核及以上，内存必须4GB及以上，网卡有且仅能有一个。节点管理——纳管已有节点到集群31操作步骤步骤1登录CCE控制台，单击左侧导航栏的“资源管理>集群管理”，单击待纳管集群下的“更多>纳管节点”。步骤2（可选）登录CCE控制台，单击左侧导航栏的“资源管理>节点管理”，选择节点所在的集群后，单击页面右上角的“纳管节点”。步骤3在打开的界面中展示了当前符合要求的弹性云主机。如果不符合纳管要求时会显示相应的红色提示图标，列表下方会有被过滤的弹性云主机数量，鼠标移动到后方的可以查看具体原因。步骤4勾选需要纳管的弹性云主机，单击“下一步”。步骤5在“待纳管节点”页面中，按照界面提示选择“登录方式”，单击“高级配置”后的按钮，可以设置“最大实例数”、“自定义镜像仓库”和“资源分配”，然后单击“提交”。步骤6在弹出的“信息确认”页面中确认信息无误后，单击“确定”。系统将提示节点纳管请求提交成功。节点管理——登录节点32约束与限制•SSH方式登录时要求该节点（弹性云主机ECS）已绑定弹性公网IP。•只有运行中的弹性云主机才允许用户登录。•Linux操作系统用户名为root。登录方式概述登录节点（弹性云云主机ECS）的方式有如下两种：•管理控制台远程登录（VNC方式）未绑定弹性公网IP的弹性云主机可通过管理控制台提供的远程登录方式直接登录。•SSH方式登录仅适用于Linux弹性云主机。您可以使用远程登录工具（例如PuTTY、Xshell、SecureCRT等）登录弹性云主机。如果普通远程连接软件无法使用，您可以使用云服务器ECS管理控制台的管理终端连接实例，查看云服务器操作界面当时的状态。说明：•SSH方式登录包括SSH密钥和SSH密码两种方式。•本地使用Windows操作系统登录Linux节点时，输入的镜像用户名（Auto-loginusername）为：root。CCE控制台不提供针对节点的操作系统升级，也不建议您通过yum方式进行升级，如果您在节点上通过yumupdate升级了操作系统，会导致容器网络的组件不可用。节点管理——节点监控33操作场景云容器引擎（CCE）与云监控服务无缝集成，可以实时查看每个集群工作节点的资源使用情况，您可以使用该服务监控您的节点，执行自动实时监控、告警和通知操作，帮助您更好地了解节点的各项性能指标。云监控服务可以对节点运行状态进行日常监控。您可以通过CCE控制台或云监控服务控制台，直观地查看节点的各项监控指标。由于监控数据的获取与传输会花费一定时间，因此，云监控显示的是当前时间5～10分钟前的节点状态。如果您的节点刚刚创建完成，请等待5～10分钟后查看监控数据。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点管理”。步骤2在列表右上角选择所需的集群，在该集群下选择所需的节点。步骤3单击节点名称后的“监控”，在云监控服务中可查看监控信息。步骤4在弹出节点监控窗口中，可查看该节点的基本监控信息，包括CPU使用率、内存使用率、磁盘使用率、CPU/内存/磁盘使用记录、上行速率、下行速率、网络监控等指标。监控指标指标含义CPU使用率该指标为从物理机层面采集的CPU使用率，数据准确性低于从弹性云主机内部采集的数据。内存使用率该指标用于统计节点的内存使用率。磁盘使用率节点的磁盘使用率，统计对象是使用率最大的磁盘，而非所有磁盘的平均使用率；节点的磁盘剩余容量，统计对象是剩余容量最大的磁盘，而非所有磁盘的剩余容量之和。CPU/内存/磁盘使用记录可查看一小时内的CPU使用率、内存使用率和磁盘使用率的曲线。下行速率一般指从网络下载数据到节点的速度，单位KB/S。上行速率一般指从节点上传网络的速度，单位KB/S。网络监控可查看一小时内的下行速率、上行速率的曲线。节点管理——管理节点标签34节点标签可以给节点打上不同的标签，给节点定义不同的属性，通过这些标签可以快速的了解各个节点的特点。节点标签使用场景节点标签的主要使用场景有两类。•节点管理：通过节点标签管理节点，给节点分类。•工作负载与节点的亲和与反亲和：有的工作负载需要的CPU大，有的工作负载需要的内存大，有的工作负载需要IO大、可能会影响其他工作负载正常工作等等，此时建议给节点添加不同标签。在部署工作负载的时候，就可以选择相应标签的节点亲和部署，保证系统正常工作；反之，可以使用节点的反亲和部署。一个系统可以分为多个模块，每个模块由多个微服务组成，为保证后期运维的高效，可以将节点打上对应模块的标签，让各模块部署到各自的节点模块上，互不干扰、方便开发到各自节点上去维护。节点固有标签节点创建出来会存在一些固有的标签，并且是无法删除的，这些标签的含义请参见表：键值failure-domain.beta.kubernetes.io/is-baremetal表示是否为裸金属节点。例如：false，表示非裸金属节点failure-domain.beta.kubernetes.io/region表示节点当前所在区域。failure-domain.beta.kubernetes.io/zone表示节点所在区域的可用区。node.kubernetes.io/subnetid表示子网的ID。os.architecture表示节点处理器架构。例如：amd64，表示AMD64位的处理器os.name表示节点的操作系统名称。os.version表示节点内核版本。节点管理——管理节点标签35添加节点标签步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点管理”。步骤2在节点列表中，单击“操作”栏的“标签管理”。步骤3在弹出的“标签管理”窗口中，单击标签列表下方的“添加标签”，填写需要增加标签的“键”和“值”，单击“确定”。例如，填写的键为“deploy_qa”，值为“true”，就可以从逻辑概念表示该节点是用来部署QA（测试）环境使用。步骤4标签添加成功后，再次单击“标签管理”，可查看到已经添加的标签。删除节点标签删除标签只能够删除用户添加的标签，节点固有的标签不能删除。步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点管理”。步骤2在节点列表中，单击“操作”栏的“标签管理”。步骤3单击“删除”，单击“确定”，删除标签。可查看到“标签变更成功”。节点管理36节点管理——同步节点信息37操作场景集群中的每一个节点对应一台弹性云主机或物理机，集群节点创建成功后，您仍可以根据需求，修改云服务器的名称或变更规格。CCE节点的部分信息是独立于弹性云主机ECS维护的，当您在ECS控制台中修改云服务的名称、弹性公网IP，以及变更计费方式或变更规格后，需要通过“同步节点信息”功能将信息同步到CCE控制台相应节点中，同步后信息将保持一致。ECS常见信息修改如下：修改节点名称。计费方式变更。当您购买的节点规格无法满足业务需要时，变更规格，升级vCPU、内存。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点管理”。步骤2单击节点后的“更多>同步节点信息”。说明：您也可以单击节点名称进入节点详情页，单击右上角“同步节点信息”。同步完成后，页面右上角将会提示“同步成功”。节点管理——重置节点38操作场景在CCE集群中重置节点会将该节点以及节点内运行的业务都销毁，重置前请确认您的正常业务运行不受影响，请谨慎操作。注意事项•重置节点功能不会重置控制节点，仅能对工作节点进行重置操作，如果重置后节点仍然不可用，请删除该节点重新购买。•重置节点将对节点操作系统进行重置安装，节点上已运行的工作负载业务将会中断，请在业务低峰期操作。•节点重置后操作系统版本不变，但工作节点的系统盘和docker数据盘将会被清空，重置前请事先备份重要数据。•用户节点如果有自行挂载了数据盘，重置完后会清除挂载信息，请事先备份重要数据，重置完成后请重新执行挂载行为，数据不会丢失。•节点上的工作负载实例的IP会发生变化，但是不影响容器网络通信。•云硬盘必须有剩余配额。•操作过程中，后台会把当前节点设置为不可调度状态。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点管理”，单击节点后的“更多>重置节点”。步骤2在弹出的“重置节点”窗口中输入RESET，同时重新配置密码或密钥登录方式。步骤3单击“是”，等待完成节点重置。重置节点后，原有节点上的工作负载实例会自动迁移至其他可用节点。节点管理——删除节点39操作场景在CCE集群中删除节点会将该节点以及节点内运行的业务都销毁，删除前请确认您的正常业务运行不受影响，请谨慎操作。约束与限制•删除CCE集群时，ECS节点也将一起删除，暂不支持删除CCE集群而保留ECS节点。•对于包周期（包年/包月）预付费的ECS节点不能直接删除，请通过页面右上角用户名下的“我的订单”，执行资源退订操作。注意事项•删除节点会涉及Pod迁移，可能会影响业务，请在业务低峰期操作。•操作过程中可能存在非预期风险，请提前做好相关的数据备份。•操作过程中，后台会把当前节点设置为不可调度状态。•删除节点仅能移除工作节点，不会移除控制节点。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点管理”，单击节点后的“更多>删除”。步骤2在弹出的“删除节点”窗口中输入DELETE，单击“是”，等待完成节点删除。说明：•删除节点后，原有节点上的工作负载实例会自动迁移至其他可用节点。•节点上绑定的磁盘和EIP如果属于重要资源请先解绑，否则会被级联删除。•释放ECS实例仅释放“按需计费”的ECS实例。节点管理——移除节点40移除节点移除节点指从集群中移除“弹性云主机（简称ECS）”，并不会删除ECS和卸载已安装的CCE相关组件。如需清理CCE相关组件，请前往ECS控制台将机器关机后，点击“更多>镜像/磁盘>重装系统”操作。步骤1在CCE控制台中，选择导航栏的“资源管理>节点管理”，在节点列表中，单击待移除节点后方“操作”栏中的“更多>移除”。步骤2在弹出的“移除纳管节点”弹框中，输入REMOVE，确认移除该节点，单击“确定”，即可移除纳管的节点。说明：以上步骤仅从集群中移除了节点（即弹性云主机ECS），并不会删除节点和已安装的CCE相关组件。请根据界面中展示的步骤清理CCE相关资源。节点管理——节点关机41操作场景集群中的节点关机后，该节点以及节点内的业务将停止运行，节点关机前，请先确认您的正常业务运行将不受影响，请谨慎操作。节点关机后不再收费。约束与限制•节点关机会涉及Pod迁移，可能会影响业务，请在业务低峰期操作。•操作过程中可能存在非预期风险，请提前做好相关的数据备份。•操作过程中，后台会把当前节点设置为不可调度状态。•节点关机仅能对工作节点关机，不会对控制节点关机。操作方法步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点管理”。步骤2在节点管理列表中，单击待关机节点的名称。步骤3在打开的节点管理详情页中，单击节点名称。步骤4页面跳转至弹性云主机详情页中，单击右上角的“关机”，在弹出的关机窗口中单击“是”，即可完成关机操作。节点管理——节点滚动升级42操作场景用户在不删除现有节点的情况下，将工作负载迁移到新的节点上。迁移流程如下图所示。

第一章•第一节集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他43节点池管理——节点池概述44为更好地管理Kubernetes集群内的节点，云容器引擎CCE引入节点池概念。节点池是集群中具有相同配置的一组节点，一个节点池包含一个节点或多个节点。可以在CCE控制台中创建新的自定义节点池，借助节点池基本功能方便快捷地创建、管理和销毁节点，而不会影响整个集群。新节点池中所有节点的参数和类型都彼此相同，无法在节点池中配置单个节点，任何配置更改都会影响节点池中的所有节点。在云容器引擎中，创建集群时配置的节点参数和类型将成为默认节点池“DefaultPool”，该节点池不可编辑、删除或迁移，也不支持扩容、弹性伸缩。通过节点池功能还可以实现节点的动态扩缩容：当集群中出现因资源不足而无法调度的实例（Pod）时，自动触发扩容，减少人力成本。当满足节点空闲等缩容条件时，自动触发缩容，节约资源成本。通常情况下，节点池内的节点均具有如下相同属性：•节点操作系统。•节点Kubernetes组件启动参数。•节点自定义启动脚本。•节点“K8S标签”及“Taints”设置。节点池管理——创建节点池45操作步骤将节点池添加到现有集群。步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点池管理”。步骤2单击右上角的“创建节点池”。步骤3在创建节点池页面中，参照如下说明设置节点池选型参数。计费模式：节点池仅支持“按需计费”的计费模式，该模式将根据实际使用的资源按小时计费。节点池创建后，自建的节点池里的资源无法转包周期，默认节点池里的资源可以转包周期。您可以把自建节点池里的资源迁移到默认的节点池里后再进行转包周期的操作。如何迁移请参见迁移节点。当前区域：指节点实例所在的物理位置。请就近选择靠近您业务的区域，可减少网络时延，提高访问速度；不同区域的云服务产品之间内网互不相通。节点池名称：新建节点池的名称，默认按“集群名-nodepool-随机数”生成名称，可自定义。节点类型：目前仅支持虚拟机节点。节点购买数量：该节点池下购买的节点数量，此处设置的节点数不能超过集群管理的最大节点规模，请根据业务需求和界面提示选择，如需更多配额，请单击提交工单申请扩大配额。节点池管理——创建节点池46节点池管理——创建节点池47节点池管理——创建节点池48节点池管理——创建节点池49节点池管理——创建节点池50节点池管理——创建节点池51节点池管理——创建节点池52节点池管理——管理节点池53操作场景为方便对CCE集群中的kubernetes配置参数进行管理，提供了配置管理功能，通过该功能您可以对核心组件进行深度配置，更多信息请参见kubelet。本文将介绍集群创建后对节点池的“配置管理”功能。约束与限制仅支持在v

1.15及以上版本的集群中对节点池进行配置，V

1.15以下版本不显示该功能。默认节点池DefaultPool不支持修改该类配置。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点池管理”。步骤2在集群选择框中，选择集群，可查看到当前集群下所有的节点池。步骤3单击节点池名称后的“配置管理”。步骤4在侧边栏滑出的“配置管理”窗口中，根据业务需求修改Kubernetes的参数值组件参数详情默认修改限制dockernative-umask`--exec-optnative.umasknormal-docker-base-size`--storage-optsdm.basesize10G-kube-proxyconntrack-minsysctl-wnet.nf_conntrack_max131072支持在节点池生命周期中修改conntrack-tcp-timeout-close-waitsysctl-wnet.netfilter.nf_conntrack_tcp_timeout_clouse_wait1h0m0skubeletcpu-manager-policy`--cpu-manager-policynone支持在节点池生命周期中修改kube-api-qps与kube-apiserver通信的qps100kube-api-burst与kube-apiserver通信的burst100max-podskubelet管理的pod上限110with-local-dns是否使用本地IP作为该节点的ClusterDNSfalseallowed-unsafe-sysctls允许使用的不安全系统配置[]节点池管理——管理节点池54节点池管理——管理节点池55编辑节点池步骤1登录，在左侧导航栏中选择“资源管理>节点池管理”。步骤2在集群选择框中，选择集群，可查看到当前集群下所有的节点池。步骤3单击节点池名称后的“编辑”，在弹出的“编辑节点池”中，配置参数：参数参数说明节点池名称自定义节点池名称。节点个数请根据业务需求调整节点个数。弹性扩缩容默认不开启。单击开启后，节点池将根据业务需求自动创建或删除节点池内的节点，参数设置如下：•节点数上限和节点数下限：您可设置节点数的上限和下限，保证节点数在合理的范围内伸缩。•优先级：该数值表示节点池之间进行弹性扩缩容的优先级，数值越大优先级越高，如设置为4的节点池比设置为1的节点池优先启动弹性伸缩。若多个节点池的值设置相同，如都设置为2，表示这几个节点池之间不分优先级，系统将按最小资源浪费原则进行伸缩。•弹性缩容冷却时间：请设置时间，单位为分钟。弹性缩容冷却时间是指当前节点池扩容出的节点多长时间不能被缩容。为保证功能的正常使用，节点池开启弹性扩缩容功能后，请务必安装autoscaler。Taints默认为空。支持给该节点池扩容出来的节点加Taints来设置反亲和性，每个节点池最多配置10条Taints，每条Taints包含以下3个参数：−Key：必须以字母或数字开头，可以包含字母、数字、连字符、下划线和点，最长63个字符；另外可以使用DNS子域作为前缀。−Value：必须以字符或数字开头，可以包含字母、数字、连字符、下划线和点，最长63个字符。−Effect：只可选NoSchedule，PreferNoSchedule或NoExecute。须知：Taints配置时需要配合Pod的toleration使用，否则可能导致扩容失败或者Pod无法调度到扩容节点。K8S标签K8S标签是附加到Kubernetes对象（比如Pods）上的键值对，旨在用于指定对用户有意义且相关的对象的标识属性，但不直接对核心系统有语义含义。节点池管理——管理节点池56删除节点池删除节点池，会先删除节点池中的节点，节点删除后，原有节点上的工作负载实例会自动迁移至其他节点池的可用节点。如果工作负载实例具有特定的节点选择器，且如果集群中的其他节点均不符合标准，则工作负载实例可能仍处于无法安排的状态。步骤1登录，在左侧导航栏中选择“资源管理>节点池管理”。步骤2在集群选择框中，选择集群，可查看到当前集群下所有的节点池。步骤3单击节点池名称后的“更多>删除”。步骤4在弹出的“删除节点池”窗口中，请仔细阅读界面提示。步骤5确定要对节点池进行删除操作后，请在输入框中输入DELETE并单击“是”，即可完成节点池的删除。拷贝节点池通过CCE控制台可以方便的拷贝现有节点池的配置，从而创建新的节点池。步骤1登录，在左侧导航栏中选择“资源管理>节点池管理”。步骤2在集群选择框中，选择集群，可查看到当前集群下所有的节点池。步骤3单击节点池名称后的“更多>拷贝”。步骤4在弹出的“创建节点池”窗口中，可以看到拷贝的节点池配置，您可以根据需要进行修改，确定配置后单击“下一步：配置确认”。步骤5在“配置确认”步骤中再次确认规格并单击“提交”，即可完成节点池的拷贝并创建新的节点池。迁移节点您可以将同一个集群下某个节点池中的节点迁移到默认节点池（defaultpool）中，暂不支持将默认节点池（defaultpool）中的节点迁移到其他节点池中，也不支持将自定义节点池中的节点迁移到其他自定义节点池。步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>节点池管理”。步骤2在集群选择框中，选择集群，可查看到当前集群下所有的节点池。节点池管理——管理节点池57节点池管理——管理节点池58

第一章•第一节集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他59网络管理——网络概述60云容器引擎通过将Kubernetes网络和VPC深度集成，提供了稳定高性能的容器网络，能够满足多种复杂场景下工作负载间的互相访问。约束与限制每个命名空间下，创建的服务数量不能超过6000个。此处的服务对应kubernetes的service资源，即工作负载所添加的服务。容器开启hostPort或hostNetwork网络模式后，若需对外提供服务，则需要给容器所在节点开启对应端口的安全组(containerPort)。Service基本概念Kubernetes中每一个工作负载会有一个或多个实例（Pod），每个实例（Pod）的IP地址由网络插件动态随机分配（Pod重启后IP地址会改变）。为屏蔽这些后端实例的动态变化和对多实例的负载均衡，引入了Service这个资源对象。Service是一种资源，提供了我们访问单个或多个容器应用的能力。每个服务在其生命周期内，都拥有一个固定的IP地址和端口。每个服务对应了后台的一个或多个Pod，通过这种方式，客户端就不需要关心Pod所在的位置，方便后端进行方便的Pod扩容、缩容等操作。用户在Kubernetes中可以部署各种容器，其中一部分是通过HTTP、HTTPS协议对外提供七层网络服务，另一部分是通过TCP、UDP协议提供四层网络服务。而Kubernetes定义的Service资源就是用来管理集群中四层网络的服务访问。根据创建Service的type类型不同，可分成如下模式：ClusterIP：默认类型，为服务分配集群虚拟IP，此时集群内部的pod可以通过服务名称寻址到服务的集群虚拟IP地址，集群外无效。NodePort：在每个节点上为服务分配静态端口号，此时如果在集群外部访问任何一个节点的IP地址加指定的端口号，kube-proxy会将流量转发到服务的集群虚拟IP，再由虚拟IP寻址到Pod。LoadBalancer：通过云服务供应商提供的loadbalancer向外部暴露服务，由指定的loadbalancer负责对NodePort与ClusterIP服务的路由。ClusterIP和NodePort类型的Service，在不同云服务商或是自建集群中的行为表现通常情况下相同。而LoadBalancer类型的Service，由于使用了云服务商的负载均衡进行服务暴露，云服务商会围绕其负载均衡的能力提供不同的额外功能。例如，控制负载均衡的网络类型，后端绑定的权重调节等。网络管理——网络模型61七层负载均衡（Ingress）通常情况下，service和pod的IP仅可在集群内部访问。集群外部的请求需要通过负载均衡转发到service在Node上暴露的NodePort上，然后再由kube-proxy通过边缘路由器(edgerouter)将其转发给相关的Pod或者丢弃，而Ingress就是为进入集群的请求提供路由规则的集合。Ingress可以给service提供集群外部访问的URL、负载均衡、SSL终止、HTTP路由等。为了配置这些Ingress规则，集群管理员需要部署一个Ingresscontroller，它监听Ingress和service的变化，并根据规则配置负载均衡并提供访问入口。Ingress的组成部分：•Nginx：实现负载均衡到pod的集合。IngressController：从集群api获取services对应pod的ip到nginx配置文件中。•Ingress：为nginx创建虚拟主机。网络策略（NetworkPolicy）网络策略（NetworkPolicy）是一种关于pod间及pod与其他网络端点间所允许的通信规则的规范。NetworkPolicy资源使用标签选择pod，并定义选定pod所允许的通信规则。网络管理——62网络管理——Service63操作场景集群内访问表示工作负载暴露给同一集群内其他工作负载访问的方式，可以通过“集群内部域名”访问。集群内部域名格式为“<自定义的服务名称>.<工作负载所在命名空间>.svc.cluster.local:<端口号>”，例如“nginx.default.svc.cluster.local:80”。访问通道、容器端口与访问端口映射如下图所示。网络管理——Service64工作负载创建时设置您可以在创建工作负载时通过CCE控制台设置Service访问方式，如下：步骤1参考创建无状态负载(Deployment)、创建有状态负载(StatefulSet)或创建守护进程集(DaemonSet)，在“工作负载访问设置”步骤，单击“添加服务”。步骤2单击“下一步”进入“高级设置”页面，直接单击“创建”。步骤3单击“查看工作负载详情”，在“访问方式”页签下获取访问地址，例如10.

247.

74.100:8080。工作负载创建完成后设置您可以在工作负载创建完成后对Service进行配置，此配置对工作负载状态无影响，且实时生效。具体操作如下：步骤1登录CCE控制台，在左侧导航栏中选择“工作负载>无状态负载Deployment”，在工作负载列表页单击要设置Service的工作负载名称。步骤2在“Service”页签，单击“添加Service”。步骤3在“添加Service”页面，访问类型选择“集群内访问(ClusterIP)”。步骤4设置集群内访问参数。步骤5单击“创建”。工作负载已添加“集群内访问(ClusterIP)”的服务。网络管理——Ingress65七层负载均衡（Ingress）是采用了共享型弹性负载均衡和独享型弹性负载均衡，在四层负载均衡访问方式的基础上支持了URI配置，通过对应的URI将访问流量分发到对应的服务。同时，服务根据不同URI实现不同的功能。七层负载均衡访问方式由弹性负载均衡ELB服务地址、设置的访问端口、定义的URI组成，例如：10.

117.

117.117:80/helloworld。通过配置公网类型和私网类型的负载均衡实例可以实现公网的七层路由转发和内网（同一VPC内）的七层路由转发。

第一章•第一节集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他66存储管理67容器存储是为容器工作负载提供存储的组件，支持多种类型的存储，同一个工作负载（pod)可以使用任意数量的存储。存储类型选择创建工作负载时，可以使用以下类型的存储。建议将工作负载pod数据存储在云存储上。若存储在本地磁盘上，节点异常无法恢复时，本地磁盘中的数据也将无法恢复。本地硬盘：将容器所在宿主机的文件目录挂载到容器的指定路径中（对应Kubernetes的HostPath），也可以不填写源路径（对应Kubernetes的EmptyDir），不填写时将分配主机的临时目录挂载到容器的挂载点，指定源路径的本地硬盘数据卷适用于将数据持久化存储到容器所在宿主机，EmptyDir（不填写源路径）适用于容器的临时存储。配置项（ConfigMap）是一种用于存储工作负载所需配置信息的资源类型，内容由用户决定。密钥（Secret）是一种用于存储工作负载所需要认证信息、密钥的敏感信息等的资源类型，内容由用户决定。云硬盘存储卷：CCE支持将云硬盘创建的硬盘挂载到容器的某一路径下。当容器迁移时，挂载的云硬盘将一同迁移。这种存储方式适用于需要永久化保存的数据。文件存储卷：CCE支持创建SFS存储卷并挂载到容器的某一路径下，也可以使用底层SFS服务创建的文件存储卷，SFS存储卷适用于多读多写的持久化存储，适用于多种工作负载场景，包括媒体处理、内容管理、大数据分析和分析工作负载程序等场景。极速文件存储卷：CCE支持创建SFSTurbo极速文件存储卷并挂载到容器的某一路径下，极速文件存储具有按需申请，快速供给，弹性扩展，方便灵活等特点，适用于DevOps、容器微服务、企业办公等应用场景快照与备份：CCE通过云硬盘为您提供快照功能，云硬盘快照指的是云硬盘数据在某个时刻的完整拷贝或镜像，是一种重要的数据容灾手段，当数据丢失时，可通过快照将数据完整的恢复到快照时间点。存储管理68

第一章•第一节集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他69命名空间70操作场景命名空间（Namespace）是对一组资源和对象的抽象整合。在同一个集群内可创建不同的命名空间，不同命名空间中的数据彼此隔离。使得它们既可以共享同一个集群的服务，也能够互不干扰。例如可以将开发环境、测试环境的业务分别放在不同的命名空间。前提条件至少已创建一个集群。约束与限制每个命名空间下，创建的服务数量不能超过6000个。此处的服务对应kubernetes的service资源，即工作负载所添加的服务。命名空间类别命名空间按创建类型分为两大类：集群默认创建的、用户创建的。集群默认创建的：集群在启动时会默认创建default、kube-public、kube-system、kube-node-lease命名空间。−default：所有未指定Namespace的对象都会被分配在default命名空间。−kube-public：此命名空间下的资源可以被所有人访问（包括未认证用户），用来部署公共插件、容器模板等。−kube-system：所有由Kubernetes系统创建的资源都处于这个命名空间。−kube-node-lease：每个节点在该命名空间中都有一个关联的“Lease”对象，该对象由节点定期更新。NodeStatus和NodeLease都被视为来自节点的心跳，在v

1.13之前的版本中，节点的心跳只有NodeStatus，NodeLease特性从v

1.13开始引入。NodeLease比NodeStatus更轻量级，该特性在集群规模扩展性和性能上有明显提升。用户创建的：用户可以按照需要创建命名空间，例如开发环境、联调环境和测试环境分别创建对应的命名空间。或者按照不同的业务创建对应的命名空间，例如系统若分为登录和游戏服务，可以分别创建对应命名空间。命名空间——71创建命名空间步骤1登录CCE控制台，在左侧导航栏中选择“资源管理>命名空间”。单击“创建命名空间”。步骤2参照下表设置命名空间参数，其中带“*”标志的参数为必填参数。表-命名空间基本信息参数参数说明*命名空间新建命名空间的名称，命名必须唯一。*集群新建命名空间属于哪个集群。节点亲和开启后，当前命名空间下所创建的工作负载只能调度到拥有特定标签的节点上。您可以在节点管理中通过标签管理为节点添加标签。该参数仅在v

1.

13.10-r0及以上版本的集群中显示。命名空间描述输入对命名空间的描述信息。资源配额设置资源配额可以限制命名空间下的资源使用，进而支持以命名空间为粒度的资源划分。须知：建议根据需要在命名空间中设置资源配额，避免因资源过载导致集群或节点异常。例如：在集群中每个节点可以创建的实例（Pod）数默认为110个，如果您创建的是50节点规格的集群，则最多可以创建5500个实例。因此，您可以在命名空间中自行设置资源配额以确保所有命名空间内的实例总数不超过5500个，以避免资源过载。可设置配额的资源类型如下：•CPU（Core）•内存（MiB）•有状态工作负载（StatefulSet）•无状态工作负载（Deployment）•普通任务（Job）•定时任务（CronJob）•实例（Pod）•服务（Service）请输入整型数值，"0"表示不限制该资源的使用。若您需要限制CPU或内存的配额，则创建工作负载时必须指定CPU或内存请求值。步骤3配置完成后，单击“确定”。命名空间——72

第一章•第一节集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他73弹性伸缩74弹性伸缩是根据业务需求和策略，经济地自动调整弹性计算资源的管理服务。背景介绍随着Kubernetes已经成为云原生应用编排、管理的事实标准，越来越多的应用选择向Kubernetes迁移，用户也越来越关心在Kubernetes上应用如何快速扩容面对业务高峰，以及如何在业务低谷时快速缩容节约资源与成本。在Kubernetes的集群中，“弹性伸缩”一般涉及到扩缩容Pod个数以及Node个数。Pod代表应用的实例数（每个Pod包含一个或多个容器），当业务高峰的时候需要扩容应用的实例个数。所有的Pod都是运行在某一个节点（虚拟机）上，当集群中没有足够多的节点来调度新扩容的Pod，那么就需要为集群增加节点，从而保证业务能够正常提供服务。弹性伸缩在CCE上的使用场景非常广泛，典型的场景包含在线业务弹性、大规模计算训练、深度学习GPU或共享GPU的训练与推理、定时周期性负载变化等。弹性伸缩分为如下两个维度：工作负载弹性伸缩：即调度层弹性，主要是负责修改负载的调度容量变化。例如，HPA是典型的调度层弹性组件，通过HPA可以调整应用的副本数，调整的副本数会改变当前负载占用的调度容量，从而实现调度层的伸缩。集群/节点弹性伸缩：即资源层弹性，主要是集群的容量规划不能满足集群调度容量时，会通过弹出ECS等资源的方式进行调度容量的补充。两个维度的弹性组件与能力可以分开使用，也可以结合在一起使用，并且两者之间可以通过调度层面的容量状态进行解耦。弹性伸缩——集群节点弹性伸缩75弹性扩缩容：−默认不开启。−单击开启后，节点池将根据集群负载情况自动创建或删除节点池内的节点，参数设置如下：节点数上限和节点数下限：您可设置节点数的上限和下限，保证节点数在合理的范围内伸缩。优先级：请根据业务需要设置相应数值，该数值表示节点池之间进行弹性扩缩容的优先级，数值越大优先级越高，如设置为4的节点池比设置为1的节点池优先启动弹性伸缩。若多个节点池的值设置相同，如都设置为2，表示这几个节点池之间不分优先级，系统将按最小资源浪费原则进行伸缩。弹性缩容冷却时间：请设置时间，单位为分钟或小时。弹性缩容冷却时间是指当前节点池扩容出的节点多长时间不能被缩容。弹性伸缩——集群节点弹性伸缩76弹性伸缩——集群节点弹性伸缩77弹性伸缩——工作负载伸缩78弹性伸缩——节点伸缩79

第一章•第一节集群管理•第二节节点管理•第三节节点池管理•第四节网络管理•第五节存储管理•第六节命名空间•第七节弹性伸缩•第八节其他80其他——配置中心——创建配置项81操作场景配置项（ConfigMap）是一种用于存储工作负载所需配置信息的资源类型，内容由用户决定。配置项创建完成后，可在容器工作负载中作为文件或者环境变量使用。配置项允许您将配置文件从容器镜像中解耦，从而增强容器工作负载的可移植性。配置项价值如下：•使用配置项功能可以帮您管理不同环境、不同业务的配置。•方便部署相同工作负载的不同环境，配置文件支持多版本，方便您进行更新和回滚工作负载。•方便快速将您的配置以文件的形式导入到容器中。前提条件若已有集群和节点资源，无需重复操作。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“配置中心>配置项（ConfigMap）”，单击“创建配置项”。步骤2参照下表设置新增配置参数。参数参数说明配置名称新建的配置名称，同一个命名空间里命名必须唯一。所属集群使用新建配置的集群。集群命名空间新建配置所在的命名空间。若不选择，默认配置为default。描述配置项的描述信息。配置数据工作负载配置的数据可以在容器中使用，或被用来存储配置数据。其中，“键”代表文件名；“值”代表文件中的内容。

1.单击“添加更多配置数据”。

2.输入键、值。配置标签标签以Key/value键值对的形式附加到各种对象上（如工作负载、节点、服务等）。标签定义了这些对象的可识别属性，用来对它们进行管理和选择。

1.单击“添加标签”。

2.输入键、值。其他——配置中心——使用配置项82配置项创建后，可在工作负载环境变量、命令行参数和数据卷三个场景使用。本节以下面这个ConfigMap为例，具体介绍ConfigMap的用法。apiVersion:v1kind:ConfigMapmetadata:name:cce-configmapdata:SPECIAL_LEVEL:HelloSPECIAL_TYPE:CCE须知：在Pod里使用ConfigMap时，需要Pod和ConfigMap处于同一集群和命名空间中。其他——配置中心——创建密钥83操作场景密钥（Secret）是一种用于存储工作负载所需要认证信息、密钥的敏感信息等的资源类型，内容由用户决定。资源创建完成后，可在容器工作负载中作为文件或者环境变量使用。前提条件已创建集群和节点资源，具体操作请参见购买混合集群。若已有集群和节点资源，无需重复操作。操作步骤步骤1登录CCE控制台，在左侧导航栏中选择“配置中心>密钥（Secret）”，单击“添加密钥”。步骤2您可以直接创建密钥或基于YAML来创建。若希望通过YAML创建，请跳转至步骤4。步骤3方式一：直接创建密钥。参照下表设置基本信息。参数参数说明密钥名称新建的密钥的名称，同一个命名空间内命名必须唯一。所属集群使用新建密钥的集群。集群命名空间新建密钥所在的命名空间，默认为default。描述密钥的描述信息。密钥类型新建的密钥类型。•Opaque：一般密钥类型。•kubernetes.io/dockerconfigjson：存放拉取私有仓库镜像所需的认证信息。•IngressTLS：存放7层负载均衡服务所需的证书。•其他：若需要创建其他类型的密钥，请手动输入密钥类型。密钥数据工作负载密钥的数据可以在容器中使用。•当密钥为Opaque类型时。

1.单击“添加更多密钥数据”。

2.输入键、值。其中“值”必须使用Base64编码，Base64编码方法请参见如何进行Base64编码。•当密钥为kubernetes.io/dockerconfigjson类型时，输入私有镜像仓库的帐号和密码。•当密钥为IngressTLS类型时，上传证书文件和私钥文件。说明

1、证书是自签名或CA签名过的凭据，用来进行身份认证。

2、证书请求是对签名的请求，需要使用私钥进行签名。密钥标签标签以Key/value键值对的形式附加到各种对象上（如工作负载、节点、服务等）。标签定义了这些对象的可识别属性，用来对它们进行管理和选择。

1.单击“添加标签”。

2.输入键、值。步骤4方式二：基于YAML文件创建密钥。说明：若需要通过上传文件的方式创建资源，请确保资源描述文件已创建。CCE支持json或yaml格式。您可以导入或直接编写文件内容，格式为YAML或JSON。方式一：导入编排文件。方式二：直接编排内容。在编排内容区域框中，输入YAML或JSON文件内容。步骤5配置完成后，单击“创建”。密钥列表中会出现新创建的密钥其他——配置中心——使用密钥84密钥创建后，可在工作负载环境变量和数据卷两个场景使用。须知：如下密钥为CCE系统使用的，请勿对其做任何操作。•不要操作kube-system下的secrets。•不要操作任何命名空间下的default-secret、paas.elb。其中，default-secret用于SWR的私有镜像拉取，paas.elb用于该命名空间下的服务对接ELB。•使用密钥配置Pod的数据卷•使用密钥设置Pod的环境变量本节以下面这个所Secret为例，具体介绍Secret的用法。apiVersion:v1kind:Secretmetadata:name:mysecrettype:Opaquedata:username:my-username#用户名password:******#需要用Base64编码说明：在Pod里使用密钥时，需要Pod和密钥处于同一集群和命名空间中。云容器引擎创建工作负载85•创建负载名称命名空间数量•选择镜像私有镜像（需要结合镜像产品）第三方镜像共享镜像•负载类型无状态负载（Deployment）有状态负载（StatefulSet）守护进程（DaemonSet）普通任务（Job）定时任务（cronJob）容器组（Pod）云容器引擎配置工作负载的容器规格86配置包括：基本信息生命周期健康检查环境变量数据存储安全设置容器日志云容器引擎创建服务87•选择服务端口•配置服务策略（升级，迁移，调度等策略）云容器引擎创建INGRESS和公网负载均衡88•配置Ingress名称，集群名称，命名空间•配置负载均衡服务（如果第一次使用，需要创建新的公网负载均衡ELB）•转发策略配置，配置主机名和目录将WEB访问转发到工作负载89云容器引擎访问服务•查看负载均衡和端口•编辑客户端HOSTS文件（可选）•根据域名访问集群上部署的负载90•产品定义：容器镜像服务(SoftwareRepositoryforContainer，简称SWR)是一种支持镜像全生命周期管理的服务，提供简单易用、安全可靠的镜像管理功能，帮助用户快速部署容器化服务。•应用场景：容器镜像服务为用户提供了云上的容器镜像管理服务，本服务主要搭配容器引擎产品使用，用于容器引擎创建应用和升级应用过程。•产品优势简单易用•无需自行搭建和运维，即可快速推送拉取容器镜像。•容器镜像服务的管理控制台简单易用，镜像的全生命周期管理操作便利。安全可靠•容器镜像服务遵循HTTPS协议保障镜像安全传输，提供帐号间、帐号内多种安全隔离机制，确保用户数据访问的安全。•容器镜像服务依托专业存储服务，确保镜像存储更可靠。容器镜像服务产品定义91•镜像中心提供tomcat、httpd、mysql、nginx等多种常用官方Docker镜像，支持用户快速部署应用，搭建业务。丰富的官方镜像•支持用户创建与删除项目，并支持设置项目属性。通过设置项目属性，确定后续上传到其中的镜像的适用范围。项目管理•支持用户上传和下载镜像，若用户上传到公共属性的镜像仓库中，该镜像还可以共享给天翼云的其他用户。镜像管理•支持用户创建与删除镜像仓库，并继承项目的属性（与项目同为私有或公有），可对私有镜像进行归类整理。镜像仓库管理容器镜像服务产品特性92容器镜像服务使用流程•镜像的拉取通过在docker上进行镜像仓库配置完成•镜像可以结合容器引擎和Serverless服务使用容器镜像服务产品使用93•创建组织•上传镜像•镜像的拉取通过在docker上进行镜像仓库配置完成•镜像也可以结合容器引擎和Serverless服务使用目录

第一章.天翼云容器引擎CCE

第二章.应用容器部署CCE实战

第三章.容器化部署后运维能力提升95

第二章第三节：应用容器化打包和测试第二节：虚拟机和基础软件部署第四节：CCE集群创建第一节：应用容器化部署概述第五节：在CCE集群部署应用

961.1WEB应用部署的通用框架基础软件层后端JAVAPYTHONPHP数据库缓存消息日志前端WEB服务器网页三要素前端框架

971.

1.1主流WEB应用部署分析-PHPWEB服务器PHP文件网页文件（html/js/css）PHP解析器HTTP请求DBDBfastcgi接口

981.

1.2主流WEB应用部署分析-PYTHONWEB服务器网页文件（html/js/css）PYTHONHTTP请求DBDBwsgi接口PY程序(Django,Flask)

991.

1.3主流WEB应用部署分析-JAVA-TOMCATWEB服务器war包网页文件（html/js/css）java（Tomcat）HTTP请求DBDBHTTP接口（jsp）100

1.

1.4常规的WEB程序如何运行-JAVA-SPRINGBOOTWEB服务器jar包springboot网页文件（html/js/css）javaHTTP请求DBDBHTTP接口10

11.3常规WEB应用如何部署获得服务器（虚拟机）数据库MYSQL，PGSQL）...WEB服务器Nginx，Apache...Java/Python/PHP/Tomcat...操作系统安装基础软件安装应用软件安装数据库导入...WEB网页，PHP文件...Jar,War,Python程序导入...配置和启动服务提供主要问题：1）运行环境不一致（各类软件版本）2）运行时环境差异问题（各类环境变量和参数）3）资源利用率问题（虚拟机需要运行操作系统，层递多）4）扩展性问题（一个虚拟机的一般只能运行一个同类程序，且进程无法隔离）启动脚本，启动参数...网页位置，程序位置...数据库权限，连接...Centos、Ubnuntu...10

21.4常规应用向云IAAS迁移物理机数据库MYSQL，PGSQL）...WEB服务器Nginx，Apache...Java/Python/PHP/Tomcat...数据...WEB网页，PHP文件...Jar,War,Python程序导入...操作系统应用层系统软件层（中间件）操作系统层物理层虚拟机数据库MYSQL，PGSQL）...WEB服务器Nginx，Apache...Java/Python/PHP/Tomcat...数据...WEB网页，PHP文件...Jar,War,Python程序导入...操作系统数据迁移应用重新部署系统软件重新部署云端自动部署从物理机到虚拟机•迁移的本质等同于应用重新在IAAS云上部署一遍•只解决了物理机的问题，应用架构还是老的一套10

31.5容器的本质是什么容器进程变化的数据=+数据+镜像=程序•更高效的利用系统资源•更快速的启动时间•一致的运行环境•更轻松的迁移•更轻松的维护和扩展10

41.6传统应用向容器化迁移应用程序（PY/PHP/JAR/WAR）网页（可能需要改造）系统软件Web，PHP，Java，Python基础操作系统CENTOS，UBUNTU配置文件，启动命令Dockerfiledockerbulild•FROM•RUN•CP/ADD•CMD•......镜像一次构建多次运行dockerrun容器环境变量，密钥参数配置文件等容器容器10

51.6容器云K8S的优势K8的优势：基于容器的应用部署、维护和滚动升级负载均衡和服务发现跨机器和跨地区的集群调度自动伸缩无状态服务和有状态服务广泛的Volume支持插件机制保证扩展性虚拟机:OPENSTACKVSKVM容器：K8SVSDOCKERDOCKER的缺点：单机上的容器管理10

61.7CCE集群的优势计算（ECS）存储（EVS/OBS/SFS）网络（VPC/EIP）多样的生态接入•支持多语言多框架服务接入•支持第三方模板和镜像快速部署完全开放的原生平台•紧跟Kubernetes和Docker社区，迅速同步最新版本•支持原生API调用和命令行操作增强的商用化特性•通过自动化配置、构建、部署提升业务上线效率•通过跨可用区高可用和控制面HA提升业务可靠性•通过物理共享集群提供敏捷可靠的容器适应业务多样性高性能基础设施•支持多种异构IaaS：虚拟机、物理机、ARM服务器•支持多种存储：云硬盘、对象存储、文件存储•对接公私网络：虚拟私有网络、EIP公网开源原生平台商业增强特性控制面HA跨AZ高可用Source2ImageI层资源插件镜像签名安全容器自动化配置自动化构建自动化部署节点自动伸缩GUI/CLI/API物理共享集群多语言多框架Java/Python/Go/Node.js第三方模板&镜像仓库K8SHelm/DockerHub第三方服务&工具Kafka/Nginx/APM/Monitor优势：天翼云容器引擎是基于开源K8S、Docker技术的企业级容器服务10

71.8实操环境和要求（应用容器化迁移改造和部署要求）操作PC（每人一台）1）创建LINU云主机2）安装和配置数据库MARIADB3）安装DOCKER4）部署缓存5）应用程序容器化打包镜像制作和测试VPC1）创建CCE集群（控制和计算节点）2）上传镜像到仓库3）制作配置文件4）运行容器5）验证已部署的应用6）应用监控和管理云主机CCE集群108

第二章第三节：应用容器化打包和测试第二节：虚拟机和基础软件部署第四节：CCE集群创建第一节：应用容器化部署概述第五节：在CCE集群部署应用10

92.1申请云主机1）创建VPC，网络和子网2）创建云主机一台（2C4G，系统盘40G)3）绑定弹性IP地址一个，带宽1M4）从互联网SSH访问注意主机安全组设置！110

2.2部署数据库1）安装数据库mariadb#yuninstallmariadbmariadb-server2）修改数据库字符集#vim/etc/my.cnf在[mysqld]下，增加字符集配置character-set-server=utf83）启动数据库#systemctlstartmariadb#systemctlenablemariadb

1112.2部署数据库4）配置数据库root密码#mysql_secure_installation5）查看数据库字符集#mysql-uroot-pXXXXshowvariableslike'%character%';6）为数据库远程访问授权#mysql-uroot-pXXXXgrantallon*.*to'root'@'%'identifiedby'XXX';7）测试是否能远程访问mysql-uroot-pXXXX-h

127.0.0.

11122.2安装DOCKER1）安装docker#yuminstalldocker2）启动docker#systemctlstartdocker#systemctlenabledocker3）检查DOCKER状态#dockerps4）运行镜像#dockerrunhello-world

1132.3部署REDIS缓存服务1）拉取REDIS镜像#dockerpullredis#dockerimages2）启动REDIS#dockerrun-d-p6379:6379redis#dockerps3）进入容器，查看运行情况#dockerps#dockerexecitxxx/bin/bash>redis-cli114

第二章第三节：应用容器化打包和测试第二节：虚拟机和基础软件部署第四节：CCE集群创建第一节：应用容器化部署概述第五节：在CCE集群部署应用

1153.1上传程序1）在家目录下创建一个工作目录#mkdirworkdir2）将给定test文件夹下所有文件拷贝到workdir下3）查看程序目录结构#treetest

1163.2修改DOCKERFILE4）编辑一个Dockfile文件，内容如下#vimDockerfileFROMpython:

3.7-slim-bullseyeCOPYtest//root/#RUNsed-i's#http://archive.ubuntu.com/#http://mirrors.tuna.tsinghua.edu.cn/#g'/etc/apt/sources.list;RUNsed-i's#http://snapshot.debian.org/#http://mirrors.tuna.tsinghua.edu.cn/#g'/etc/apt/sources.list;RUNsed-i's#http://deb.debian.org/#http://mirrors.tuna.tsinghua.edu.cn/#g'/etc/apt/sources.list;RUNcat/etc/apt/sources.list;RUNapt-getupdate\&&apt-getupgrade-y\&&apt-getinstall-ylibmariadb-dev-compatlibmariadb-dev\&&apt-getinstall-ygcc\&&/usr/local/bin/python-mpipinstall--upgradepip\&&pip3installDjangodjango-simpleui==20

22.

4.9requests==

2.

27.1urllib3==

1.

26.9async-timeout==

4.0.2django-redis==

5.

2.0mysqlclient==

2.

1.0Pillow==

9.

1.0-ihttps://pypi.tuna.tsinghua.edu.cn/simple--trusted-hostpypi.tuna.tsinghua.edu.cnEXPOSE8000CMD["/bin/sh","/root/start.sh"]

1173.3修改程序的配置文件5）修改程序的配置文件#cd#cdworkdir/test/hospital_registration_system#vimsettings.py修改两处（数据连接和REDIS连接）MYSQL服务器连接（IP地址和端口号\用户名\密码根据实际情况修改为本机提供的数据库服务MYSQL服务器连接（IP地址和端口号\用户名\密码根据实际情况修改本机提供的REDIS服务思考？本机IP地址是什么？MYSQL和REDIS服务端口号是哪个？

1183.4程序打包为容器镜像6）将程序打包为DOCKER镜像#dockerbuild-tpythonapp:v

1.7）查看打包结果#dockerimages

1193.5运行镜像并测试8）镜像测试#dockerrun-d-p8000:8000pythonapp:v1#dockerps#curl

127.0.0.1:8000120

3.6导出镜像9）倒出镜像#dockersavepythonapp:v1-omyapp.tar#llmyapp.tar121

第二章第三节：应用容器化打包和测试第二节：虚拟机和基础软件部署第四节：CCE集群创建第一节：应用容器化部署概述第五节：在CCE集群部署应用

1224.1CCE服务引擎创建•版本•节点规模(50,200,1000,2000)•控制节点数量(单节点，多节点）•计费方式•节点（该节点为合营）选择按需计费，控制节点数量为1服务进入路径：选择站点-控制中心-容器服务-CCE

1234.1CCE服务引擎创建创建容器网络•虚拟私有云•VPC网络•容器网段

1244.2计算节点创建•选择计算节点云主机规格和数量•云主机的配置：操作系统子网是否配置弹性IP登录方式等创建2个计算节点2C8G即可，按需计费！需要配置一个弹性IP，可后续绑定！

1254.3插件安装和配置•必选插件coredns：域名解析，服务发现everest：容器存储•可选插件:autoscaler：节点扩展gpu-beta：GPU管理metrics-server：集群监控

1264.4确认配置

1274.5集群创建•安全组创建•网络创建•集群创建

1284.6查看和监控集群•集群信息•集群监控129

第二章第三节：应用容器化打包和测试第二节：虚拟机和基础软件部署第四节：CCE集群创建第一节：应用容器化部署概述第五节：在CCE集群部署应用130

5.1上传镜像•创建组织•上传镜像•先通过SSH将镜像从LINUX云主机拉到本地再上传到天翼云容器镜像服务！

1315.2创建配置项键值为settings.pysettings.py文件全部贴到这里，注意数据库，REDIS的连接参数设置

1325.3创建工作负载数量选择1个

1335.4添加容器选择之前上传的镜像

1345.5配置容器参数使用1核，1G内存

1355.6配置容器挂载配置文件配置项的键名挂载到容器内的路径和文件名选择配置项

1365.7添加服务对外暴露8000端口选择节点端口类型

1375.8选择扩缩容策略保留默认值即可

1385.9查看工作负载和服务工作节点对应的弹性IP（需要事先申请和绑定一下，否则无法从外网访问）服务查看，同样可以显示如何从外部访问服务！需要注意工作节点的安全组，建议使用FULL-ACCESS！

1395.11验证应用可用性从互联网采用节点加端口方式访问集群目录

第一章.天翼云容器引擎CCE

第二章.应用容器部署CCE实战

第三章.容器化部署后运维能力提升141应用容器化部署后运维能力提升-日志存储难应用容器化部署后日志存储问题突出輪容器环境下本地日志易丢失：随着云原生、容器化技术的流行，由于系统实例可随容器动态消失，本地存储的日志也随之消失，需要进行外部存储。輪上云后的系统联调、故障定位急需日志缩短处置时间：容器化部署后，想要查看运行日志需要借助CCE控制台或者进入容器内部查看，随着微服务的发展，容器数量越来越多，日志越来越分散，故障定位耗时长。輪传统Filebeat日志采集困难：传统Filebeat采集日志需要配置文件路径，容器动态生成和消息，路径经常变更，难以即使采集全量所需日志142应用容器化部署后运维能力提升-什么是Log-Pilot容器日志采集难点破解利器Log-PilotLog-Pilot是一个智能容器日志采集工具,能够高效便捷地将容器日志采集输出到多种后台日志存储系统中，不仅能够采集容器标准输出日志，同时能够动态发现配置采集容器内文件日志。log-pilot容器事件管理容器事件管理容器标签解析容器标签解析容器标签解析容器标签解析采集插件管理采集插件管理fluentdfilebeatfluentdfilebeat配置文件配置文件143应用容器化部署后运维能力提升-部署ELK配套代码/elk/docker-compose.yml配套代码/elk/kibana.yml#执行部署命令cd配套代码/elkdocker-composeup-d144应用容器化部署后运维能力提升-如何部署Log-Pilot#下载部署的DeamonSet描述文件https://github.com/AliyunContainerService/log-pilot/blob/master/examples/pilot-elasticsearch-kubernetes.yml或者使用配套代码/elk/pilot-elasticsearch-kubernetes.yml#使用kubectl或其他方式进行安装cd配套代码/elk/kubectlapply-fpilot-elasticsearch-kubernetes.yml145应用容器化部署后运维能力提升-如何使用log-pilotlog-pilot支持声明式日志配置，可以依据容器的Label或者ENV来动态地生成日志采集的配置文件。这里主要说明两个变量：name：我们自定义的一个字符串，它在不同的场景下指代不同的含义。当日志采集到ElasticSearch的时候，name表示的是Index；当日志采集到Kafka的时候，name表示的是Topic；path：支持两种形式，一种是约定关键字stdout，表示的是采集容器的标准输出日志，第二种是容器内部的具体文件日志路径，可以支持通配符的方式。比如我们要采集tomcat容器日志，我们可以通过配置标签aliyun.logs.catalina=stdout来采集tomcat标准输出日志，通过配置标签aliyun.logs.access=/usr/local/tomcat/logs/*.log来采集tomcat容器内部文件日志。146应用容器化部署后运维能力提升-调用链跟踪调用承载关系极其复杂，亟待引入运维工具分布式架构带来的挑战维护对象：几个Weblogic变成上百个Tomcat的容器。调用关系：从简单的总线结构，变成复杂的网状结构调用链。故障定位：微服务故障向上传递，定位故障根因困难。147应用容器化部署后运维能力提升-什么是PinpointPinpoint是一个APM（应用程序性能管理）工具，用于用Java/PHP编写的大型分布式系统。受Dapper的启发，Pinpoint提供了一种解决方案，通过跟踪分布式应用程序的事务来帮助分析系统的整体结构以及其中的组件如何互连。

1、了解应用程序拓扑

2、实时监控应用程序性能

3、获得每个事务的代码级可见性

4、安装APM代理，无需更改任何代码行

5、对性能的影响最小（资源使用量增加约3%）148应用容器化部署后运维能力提升-部署Pinpoint#部署命令gitclonehttps://github.com/pinpoint-apm/pinpoint-docker.gitcdpinpoint-dockerdocker-composepull&&docker-composeup-dzookeeper1zookeeper1zookeeper2zookeeper2zookeeper3zookeeper3hbasehbasepinpoint-webpinpoint-webpinpoint-collectorpinpoint-collectorTomcatTomcatSpringBootSpringBoot149应用容器化部署后运维能力提升-接入Pinpoint

（1）SpringBoot项目接入方式：java-javaagent:$agentlocal-Dpinpoint.agentId=$agentId-Dpinpoint.applicationName=$applicationName-jarXXX.jar参数说明填写$agentlocalagent的jar包所在地址/root/APM/pinpoint-bootstrap-

2.

3.

1.jar$agentId

1、非容器（主机+端口）

2、容器(hostname)

1、

192.

168.

121.111-9999（例）

2、66e471162ad3（例）$applicationName应用的服务名Pinpoint中服务名称，不超过24位，建议使用小写字母、中横线类似（域-系统名称-服务名称-环境）（例：bsn-epay-zhongfawater-dev）150应用容器化部署后运维能力提升-接入Pinpoint

（2）Tomcat项目接入方式(catalina.sh文件中加入）：CATALINA_OPTS="$CATALINA_OPTS-javaagent:$agentlocal"CATALINA_OPTS="$CATALINA_OPTS-Dpinpoint.agentId=$agentId"CATALINA_OPTS="$CATALINA_OPTS-Dpinpoint.applicationName=$applicationName"参数说明填写$agentlocalagent的jar包所在地址/root/APM/pinpoint-bootstrap-

2.

3.

1.jar$agentId

1、非容器（主机+端口）

2、容器(hostname)

1、

192.

168.

121.111-9999（例）

2、66e471162ad3（例）$applicationName应用的服务名Pinpoint中服务名称，不超过24位，建议使用小写字母、中横线类似（域-系统名称-服务名称-环境）（例：bsn-epay-zhongfawater-dev）开发团队瞿润萍、胡晓宇、陈悦、马嘉希、杜伟、胡琛感谢聆听！

