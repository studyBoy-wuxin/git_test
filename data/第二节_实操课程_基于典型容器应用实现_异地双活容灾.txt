基于典型场景的应用容器实现+同城双活张姣庄甲升张逍遥王蓉韩璐主要内容：灾备基础、基于天翼云的灾备方案设计与实现（同城双活+容器云同城高可用）课程时长：8小时课程形式：理论+实操课程简介

1.了解企业需求发展趋势与灾备营销场景

2.掌握灾备基础概念、云上灾备基本原理及关键核心技术

3.了解天翼云容灾相关产品

4.了解天翼云灾备典型场景及案例

5.掌握使用天翼云产品进行典型灾备解决方案设计并实操实现

6.了解典型应用容器化方案

7.掌握使用CCE部署典型应用，完成云上多活容灾设计与实现通过本课程您将：课程介绍

1.云网支撑工程师

2.解决方案工程师

3.产品支撑经理

4.客户工程师

5.云网工程师授课对象目录CONTENTS世界触手可及1灾备需求发展趋势及客户分析2灾备基础概念3云灾备关键技术及天翼云灾备产品4天翼云双活典型案例5同城异地双活+容器化云上多活实战请先思考这几个问题一般哪些系统需要备份？哪些系统需要容灾？如何区别？如何分级？重点需要关注哪些指标？对于不同行业中客户灾备的需求，从技术层面如何响应？在5G+云+AI+大数据的时代，灾备何去何从？天翼云灾备解决方案有何优势？4目录CONTENTS世界触手可及1灾备需求发展趋势及客户分析2灾备基础概念3云灾备关键技术及天翼云灾备产品4天翼云双活典型案例5同城异地双活+容器化云上多活实战

1.1先从每个人的生活工作谈起生活中每个人基本无时无刻不在做着云灾备，请看以下场景：手机：大部分手机品牌都有自己的云盘，能够自动上传照片、视频、通讯录，并将备份数据安全地存在云盘中，如iphone的icloud云盘电脑：Windows操作系统自带备份功能、Mac的icloud云盘备份等云盘软件：天翼云盘、百度网盘、阿里云盘等等：相册视频自动备份，再也不怕丢照片了许多软件也自带了备份功能：如QQ同步助手、WPS定时备份功能等等

61.2灾难不可预知，没有绝对的安全拿什么赌明天？业务稳定、数据安全决定着一家企业的生死与未来，这绝对不是危言耸听。灾难不可预知，现实中惨痛教训不断上演：•天津某医院数据中心因持续大雨被淹，由于未做灾备，导致医院无法开展业务；•某云服务商因为底层磁盘静默错误以及数据迁移操作不规范，导致某用户平台级数据全部丢失，业务从此难以为继；•某互联网技术服务商数据被恶意删除，恢复耗时七天七夜，赔偿客户损失

1.5亿元......•还有频繁出现的机房制冷系统故障，导致整个机房/数据中心瘫痪的例子数不胜数...建设灾备中心，防患于未“燃”

71.3企业为什么要做灾备？规避重大损失-容灾备份是有效规避数据丢失、数据破坏、业务中断等三大IT系统风险的唯一有效手段规避个人责任-一旦发生数据灾难及系统长时间中断，相关IT负责人有不可推卸的责任符合政策法规-做好容灾备份，方能符合政府及行业对等级保护及业务连续性管理的政策法规数据和业务面临的各类问题IT系统服务器、应用程序、硬件操作系统、数据库、虚拟机等故障网络安全问题网络/病毒攻击、数据窃取/丢失、篡改、加密、泄露灾害类事件地震、洪灾、火灾、雷电、战争、城市建设容灾备份产品的最终目标：帮助企业应对人为误操作、软件错误、病毒入侵等“软”性灾害以及硬件故障、自然灾害等“硬”性灾害灾备需求两问：“能否接受数据丢失？”“是否要求业务连续稳定？”

81.4相关政策法规国信办：国家标准《信息系统灾难恢复规范》(GB/T20988-2007)正式发布规定信息系统灾难恢复应遵循的基本要求，适用于信息系统灾难恢复的规划、审批、实施和管理《保险业信息系统灾难恢复管理指引》保险业信息系统灾难恢复工作应坚持“统筹规划、资源共享、平战结合、等级灾备”的原则，平衡成本与风险，确保工作的有效性。《信息安全技术灾难恢复中心建设与运维管理规范》(GB/T30285-2013)规范了容灾中心建设运维的有效性《网络安全法》34条：关键信息基础设施运营者要对重要系统和数据库进行容灾备份。59条：不履行者承担法律责任（问责、罚款）恢复速度：业务系统恢复时间尽可能短侵入性：对原有业务系统适配改造的影响成本：根据业务场景采取不同容灾技术，控制容灾成本数据安全：建立可靠的数据同步校验机制规划原则9《数据安全法》19条：对数据实行分级分类保护，精细化安全管控，做到数据备份、数据脱敏、异地容灾等多防护手段21条：国家建立数据分类分级保护制度，应急处置措施（容灾中心建设的必要）目录CONTENTS世界触手可及1灾备需求发展趋势及客户分析2灾备基础概念3云灾备关键技术及天翼云灾备产品4天翼云双活典型案例5同城异地双活+容器化云上多活实战11国务院信息化办公室在2005年发布了《重要信息系统灾难恢复指南》，用于指导信息系统的使用和管理单位的灾难恢复规划工作，以及对信息系统灾难恢复规划项目的审批和监督管理。《指南》给灾难下了一个清晰的定义：“由于人为或自然的原因，造成信息系统运行严重故障或瘫痪，使信息系统支持的业务功能停顿或服务水平不可接受、达到特定的时间的突发性事件”。

2.1数据灾难的定义

2.2灾难恢复所需技术与管理支持12数据备份系统备用数据处理系统备用网络系统备用基础设施技术支持运行维护支持灾难恢复预案IT技术范畴管理和服务范畴数据备份系统面向的对象是数据，目的是实现数据的冗余备份。常用技术有数据备份和数据复制等。备用数据处理系统面向的对象是应用服务器，目的是在主要数据处理系统发生故障时候，可以利用数据备份系统产生的冗余数据来恢复应用，常用的技术有双机热备、服务器集群等。备用网络系统面向的是网络连接，目的是保证备用数据处理系统与其客户端、不同备用数据处理系统之间的网络，以便整个实现业务系统的恢复。灾难恢复应具有的技术和管理支持分为6个等级，每个级别都包括数据备份系统、备用数据处理系统、备用网络系统、备用基础设施、技术支持、运行维护支持和灾难恢复预案这7个要素。

2.3灾备系统建设国际标准13Tier3-在线数据恢复：电子链路传送

2.4容灾的技术指标14RTO（RecoveryTimeObject，恢复时间目标）指“将信息系统从灾难造成的故障或瘫痪状态恢复到可正常运行状态，并将其支持的业务功能从灾难造成的不正常状态恢复到可接受状态”所需时间，其中包括备份数据恢复到可用状态所需时间、数据处理系统切换时间、以及备用网络切换时间等，该指标用以衡量容灾方案的业务恢复能力。RPO（RecoveryPointTime，恢复点目标）RPO是指业务系统所允许的灾难过程中的最大数据丢失量（以时间来度量），这是一个与数据备份系统所选用的技术有密切关系的指标，用以衡量灾难恢复方案的数据冗余备份能力。容灾半径指生产中心和灾备中心之间的直线距离，用以衡量容灾方案所能防御的灾难影响范围。业务连续性管理中，用户普遍最关注的两个技术指标：RTO、RPO

2.5成本及产出相关指标15TCO（TotalCostofOwnership，总体投入成本）：包括建立系统、维护系统和扩充系统的总投入ROI（ReturnofInvestment，投入产出比）：也是用户会重点关注的指标，它用以衡量用户投入到容灾系统的资金与从中所获得的收益的比率。TCO和ROI是衡量容灾系统投入和回报的主要指标，但由于容灾系统的启用概率很低，新技术的发展和新产品的性能价格比的提高，必定造成容灾设备的贬值。所以，对于容灾系统TCO越高，ROI越低。云灾备方案的核心之一是帮助企业及组织平衡RTO和RPO的需求，找到最佳总体投入（TCO）和投资回报（ROI）。不做灾备的情形下，直接和间接成本通常包括：关键任务数据损坏停机时间对企业生产效率的影响设备及其他资产的损坏检测和修复系统和核心业务过程的成本法律和法规的影响，包括诉讼辩护费用关键利益相关者之间失去的信心和信任市场的品牌和声誉的损失任何一个公司都企求找到自己合适的最佳成本点

2.6容灾系统全景图16容灾系统按照距离划分：分为本地容灾、同城容灾、异地容灾对应公有云相关概念：AZ1AZ2Region1Region2AZ3AZ1AZ2AZ3•Region(区域)：一般按地理位置来划分，公有云一个Region可能跨好几个省份，不同区域之间内网互不相通。•AZ(可用分区)：AZ是AvailabilityZone的缩写，是指一个故障隔离域，同一Region下可能有多个AZ，一个AZ的电力、冷却等都是独自使用的

2.7容灾与备份的区别容灾备份备份是为了应对灾难来临时造成的数据丢失问题。一般意义上，备份指的是数据备份或系统备份容灾是为了在遭遇灾害时能保证信息系统能正常运行，帮助企业实现业务连续性的目标一般意义上，容灾指的是不在同一机房的数据备份或应用系统备份容灾是在线过程，两地的数据是实时一致的备份是离线过程，数据则具有一定的时效性保证数据的完整性，不仅保护数据，更重要的目的在于保证业务的连续性故障情况下，容灾系统的切换时间是几秒钟至几分钟；备份只能恢复出备份时间点以前的数据，只保护数据的安全性故障情况下，备份系统的恢复时间可能几小时到几十小时在容灾备份一体化产品出现之前，容灾系统与备份系统是独立的。

172.7容灾与备份的联系18容灾与备份之间密切联系、不可分割：没有了数据备份，容灾也无从下手；而仅仅备份了数据，没有考虑周密的容灾方案，也难以发挥数据备份的作用，无法保证系统的业务持续性。备份是保障系统安全运行的基石，是数据高可用的最后一道防线。其目的是为了系统数据崩溃时能够及时恢复数据以免产生严重后果。备份是容灾的基石容灾系统会完整地把生产系统的任何变化复制到容灾端，包括不想让它复制的工作。比如：针对计费系统，不小心把系统内的用户信息表删除了，同时容灾端的用户信息表也会被完整的删除，这时如果是同步容灾，那么容灾端同时就删除了，那容灾端在数据异步复制间隔内就会被删除，这时就要从备份系统中取出最新备份，用来恢复被错误删除的信息，因此容灾不能代替代备份。容灾不能代替备份

2.8灾备技术-数据备份方式19数据备份：为防止系统出现操作失误或系统故障导致数据丢失，而将全部或部分数据集合从应用主机的硬盘或阵列复制到其它的存储介质的过程。传统的数据备份主要是采用内置或外置的磁带机进行冷备份。但这种方式只能防止操作失误等人为故障，而且其恢复时间也很长。随着技术的不断发展，数据的海量增加，不少的企业开始采用网络备份。网络备份一般通过专业的数据存储管理软件结合相应的硬件和存储设备来实现。定期磁带备份远程数据库网络数据远程镜像磁盘•LAN备份、LANFree备份和SANServer-Free备份三种。•LAN备份针对所有存储类型都可以使用，LANFree备份和SANServer-Free备份只能针对SAN架构的存储。

2.

8.1数据备份方式-本地备份20应用服务器LAN应用服务器应用服务器备份设备备份设备备份设备

2.

8.2数据备份方式-网络备份21备份服务器LAN应用服务器应用服务器备份设备备份设备数据流数据流Storagenetwork

2.

8.3数据备份方式-LANFree22备份服务器LAN应用服务器应用服务器主设备备份设备指令流Storagenetwork

2.

8.4数据备份方式-Server-Less23备份服务器LAN应用服务器应用服务器主设备备份设备指令流快照卷生产卷Storagenetwork

2.

8.5不同备份架构的比较

242.9数据备份策略---完全备份、差异备份、增量备份

252.10数据复制26数据复制（Replication）是指利用复制软件（如EMC的SRDF、H3C同步异步镜像等）把数据从一个磁盘复制到另一个磁盘，生成一个数据副本。

2.10.1数据复制-双机热备27在双机热备份方式中，主服务器运行应用，备份服务器处于空闲状态，但实时监测主服务器的运行状态。一但主服务器出现异常或故障，备份服务器立刻接管主服务器的应用。也就是目前通常所说的active/standby方式，主要通过纯软件方式实现双机容错。磁盘阵列心跳连接Internet客户端ActiveStandby服务器A服务器B应用应用A•双主机通过一条TCP/IP网络线以及一条RS-232电缆线相联•双主机各自通过一条SCSI电缆线与RAID相联•主机NT1为active，主机NT2为standby•主机NT1处理作业和数据，主机NT2作为热备份机•主机NT1故障后，主机NT2自动接管主机NT1的作业和数据•主机NT2同时接管NT1的主机名(Host)及网络地址(IP)•主机NT1的作业将在主机NT2上自动运行•主机NT1的客户(client)可继续运行，无需重新登录•主机NT1修复后，自动接管原来的作业和数据，主机NT2继续作备份机

2.10.2数据复制-双机互备28在这种方式中，没有主服务器和备份服务器之分，两台主机互为备份。主机各自运行不同应用，同时还相互监测对方状况。当任一台主机宕机时，另一台主机立即接管它的应用，以保证业务的不间断运行。也就是目前通常所说的Active/Active方式，主要通过纯软件方式实现双机容错。通常情况下,支持双机热备的软件都可以支持双机互备份方式,当前应用最广泛的双机互备软件主要有LifeKeeper,RoseHA,DataWare和MSCS。磁盘阵列心跳连接Internet客户端ActiveActive服务器A服务器B应用应用A应用B•双主机通过一条TCP/IP网络线以及一条RS-232电缆线相联•双主机各自通过一条SCSI电缆线与RAID磁盘阵列相联•双主机各自运行不同的作业，彼此独立，并相互备援•主机A故障后，主机B自动接管主机A运行•主机A的作业将在主机B上自动运行•主机A的客户(client)要在主机B上重新登录•主机A修复后，主机B将把A的作业自动交还主机A•主机B故障时，主机A接管主机B的作业和数据

2.10.3数据复制-集群技术29所谓群集（Cluster）技术就是一个域内包含多台拥有共享存储空间的服务器，各服务器通过内部局域网相互通信，群集内的任一服务器上运行的业务都可被所有的客户所使用。当一台服务器发生故障时，它所运行的应用将由其他服务器自动接管，这就实现了负载均衡和互为备份。三种集群技术高性能集群（HighPerformanceCluster）负载均衡集群（LoadingBalanceCluster）高可用性集群(HighAvailabilityCluster)

2.10.4三种技术的比较30群集并发存取方式：

1.并发处理能力：多个群集节点的数据访问是并发的、无规律的，因此就要求存储设备具有很强的处理并发数据访问能力，以使群集应用发挥最高的性能。

2.数据共享能力：多个节点的处理器能够方便地共享相关的数据，这就要求存储系统具备安全而高效的共享能力。

3.大规模与可扩展性：如何实现在线升级、平滑过渡、现有用户及素材的透明化处理，是存储产品必需的功能。

4.可管理性：一是管理操作分安全级别；二是提供清晰明确的管理界面，方便操作。避免人为误操作，要求存储系统的管理界面简单明了，管理操作流程设计合理。

5.高可用性：高性能群集的时效性很强，因此要求网络系统具有极高的可靠性。首先要求有较高的容错级别，例如控制器要求高可用容错，存储子系统要求容错冗余等；其次故障恢复时间要短，尽可能做到不宕机的在线恢复。双机热备方式：系统运行时，只有主服务器与存储系统进行数据交换。当发生主机故障切换时，要求存储系统能与备份服务器快速建立数据通道，以支持业务的快速切换。双机互备方式：系统运行时，两台主机需要同时对磁盘阵列进行读写操作，这要求存储系统具备良好的的并发读取操作和一定的负载均衡功能。

2.11新灾备模式演进

312.12云灾备与传统自建方式的比较云灾备是一种全新的灾备服务模式，主要包括传统物理主机、虚拟主机等IT系统，往私有云或公有云等云端化灾备的趋势，以及新业务形态下，灾备端云化，云与云之间的灾备等。云灾备指的不仅仅是传统的数据存储和定时复制，而是包括了数据实时传输、迁移、应用切换、保证灾备端应急接管业务应用等范畴。序号比较维度用户自建委托第三方云灾备1建设机制采购各种设备自己建设交付给第三方专业集成商或者代理商建设和管理从建设简化为采购2业务实现难易度系统整合极其复杂，出现问题多厂家互相推卸责任实际实现结果和预想结果相差甚远按需采购、即购即用，系统可靠运行3可升级和可迁移性一旦升级又要考虑设备兼容性和设备的整合，数据迁移不方便基本是将自建的烦恼委托第三方，但是必须全程主导按需调整，随时可以升级或迁移，随着企业的发展，设备可以方便的降级重复利用大大节约系统升级费4成本问题投资大，各系统均花费巨大，维护更是很大一部分投资巨大，维护成本严重受限于第三方的水平购买即可使用，运行成本低，维护简单，而且运营商级的服务保障5何种用户采用组织财力、能力经验均要求很高，特别是it技术实力强需要全部灾备服务而无能力、无经验建设任何客户6综合优势比较差中强32目录CONTENTS世界触手可及1灾备需求发展趋势及客户分析2灾备基础概念3云灾备关键技术及天翼云产品4天翼云双活典型案例5同城异地双活+容器云容灾实战

3.1业务系统上云后，是否需要做灾备？34灾害无处不在，威胁着组织的基础设施、关键人员、信息系统及关键业务数据等重要资产，直接影响到组织业务的连续运作。32%14%44%7%3%场地灾害应用软件故障人为因素操作失误或恶意破坏系统硬件故障病毒3月3日，微软位于美国东部的数据中心发生了服务中断，持续六小时，导致美国北部的客户无法使用Azure云服务。云安全事件3月26日，Google多个云服务出现无法访问的问题。（网关出现故障）4月10日，华为云出现大面积宕机，华为云登录、管理后台无法访问，部分公司业务无法正常维持。本次宕机持续约三小时。4月21日，多个GitHub服务出现访问异常，持续了一个半小时。4月22日，服务再次出现中断，持续时间至少两小时。6月9日，IBMCloud遭遇了重大宕机故障，平台上托管的多项服务也因此中断4个小时。8月24日，Zoom发生了部分中断，导致用户无法访问其离线会议和在线视频会议，本次中断持续了3小时。9月29日，MicrosoftOffice365办公软件和Azure云产品出现故障，导致部分用户服务中断数小时。11月25日，亚马逊云服务出现中断，大量网站和服务受到影响。本次宕机持续约5小时。12月14日晚间，Google服务器又一次全球宕机。这是近5个月来第3次全球宕机。--不存在“永不宕机”的云--

3.2新形势、新需求，诞生新的灾备模式35云计算与大数据时代，业务和数据上云后，风险仍然存在。如何保障业务的连续性，仍是新经济、新形势下需要考虑的内容。云灾备是一种服务，由客户付费使用灾备服务提供商提供的灾备能力。采用这种模式，客户可以利用服务提供商的优势技术资源、丰富的灾备项目经验和成熟的运维管理流程，快速实现用户的灾备目标，降低客户的运维成本和工作强度，同时也降低灾备建设的总体拥有成本。云不等于灾备云不能解决业务连续性问题云给灾备的实现带来了便利云促进灾备模式变革灾备大数据带来新需求大数据带来新问题大数据需要安全保障大数据与灾备融合创新云计算大数据

3.2什么是云灾备服务36•属于灾备服务•建设内容和方法论与灾备服务一致所属范畴•通过云的环境实现灾备•混合云灾备、私有云灾备、公有云灾备建设方式•建设简化，启动资金规模小，灵活组合，实现1至6级容灾•可以利用供应商的专业灾备服务经验，快速构建灾备体系•利用高等级灾备中心云网资源实现弹性扩展，可应对业务规模扩大，灾难应急资源需求建设特点•安全可靠•建设时间快•成本集约•可管理、可运维建设效果

3.3自建灾备VS云灾备服务•当“上云”和“云上”成为常态，“云灾备”和“灾备云”已是大势所趋。趋势自建灾备系统建设及运维痛点：•建设成本高：需要大量的服务器，且对数据库平台和操作系统版本要求比较严格•建设实施复杂：涉及到灾备中心建设方案设计、各业务模块需达到灾备级别设计、数据迁移、故障切换设计、灾备演练设计等较多的技术环节，对于IT能力不强的企业，建设门槛较高•运维难度大：灾备系统建设涉及服务器，网络，存储等等，设备系统复杂，容灾业务众多•扩展性不强：数据库、主机平台单一，集中式存储数据容灾：•难以保证数据一致性/完整性，数据安全得不到保障；•恢复效率低，且难以达到业务透明，高可用性差应用容灾：•可能存在脑裂，数据订正，幂等，切流和回切需要人工操作•恢复时间长，达不到容灾效果云灾备模式建设与运维优势：•成本优势：灾备系统上云比自建机房成本低，工期短，按需租用，且资源可使用弹性服务，起初不用一比一建设，节省资源的同时即能满足业务激增时的高峰需求，也不担心业务低谷时资源闲置浪费•建设周期极大缩短：基础设施建设由60天降为两周•可运维性和可维护性：水电设备等基础设备以及运维人员都免去了企业关注自己的主营业务，专业的人做专业的事•IT敏捷性提升：系统扩容，新业务上线，可快速申请资源，云上弹性资源的拓展速度是分钟级，即开即用数据与应用：•灾备到云：关键应用RTO在小时级，如门户、核心数据库、财务、OA、邮件等，外网应用在云端恢复、内网应用在本地恢复、关键应用有云端备份。•备份到云：非关键应用或重要文件，如重要的图纸、文件、归档数据等，可以进行安全可靠的异地备份。•容灾到云：异地灾备中心建设同城灾备数据中心或两地三中心的异地数据中心，将灾备云当做异地灾备数据中心。•仿真到云：将业务灾备到云，在云端拉起业务模拟真实场景进行测试。

3.

4.1天翼云灾备相关产品-云主机备份38云主机备份（CloudServerBackupService）支持基于多云硬盘一致性快照技术的备份服务，支持利用备份数据恢复弹性云主机数据，提供数据备份和操作系统恢复的整体方案，具备实时增量备份、快速数据恢复能力，有效保障用户数据的安全性和正确性，确保业务安全。云主机备份基本能力集场景：针对需要对整个云主机进行保护（包括云主机配置规格，以及多个云硬盘的一致性数据），或者希望通过备份创建云主机达到快速复制业务运行环境的场景计费方式：支持按需计费、包年包年资源包，计费项包括备份功能费、备份存储资源费备份方式：手动备份、自动备份备份策略：自动备份，支持指定备份周期、执行时间点、备份保留时间备份实现：首次备份为全量备份，后续备份为增量备份备份恢复：支持备份恢复到原云主机，支持使用备份数据创建新云主机限制：仅支持将云主机中的所有云硬盘作为整体进行备份和恢复，不支持对云主机中的部分云硬盘进行备份和恢复，并且不支持文件或者目录级别的恢复；不支持备份内存数据

3.

4.2天翼云灾备相关产品-云硬盘备份39云硬盘备份（VolumeBackupService）针对云主机的系统盘、数据盘提供的备份服务。提供基于磁盘快照技术的本地数据保护服务。用户可为云硬盘创建备份并利用备份实现数据回滚。云硬盘备份(CT-VBS)基本能力集计费方式：按需计费，根据备份实际占用的存储空间按小时计费备份方式：手动备份、自动备份备份对象：支持系统盘、数据盘备份备份实现：单磁盘首次全量备、后续为增量备，备份数据压缩后存储备份恢复：系统盘、数据盘备份可恢复到源盘（需将源盘卸载）。如数据盘备份后做过扩容操作，仍可使用原有备份恢复数据，但数据盘容量为未扩容前容量。基于备份创建磁盘：支持基于系统盘和数据盘备份创建新的数据盘挂载到任意云主机备份/恢复时长：取决于备份磁盘大小及是否为首次备份还是增量备份

3.

4.3天翼云灾备相关产品-数据库复制服务数据复制服务（DataReplicationService，简称DRS）是一种易用、稳定、高效、用于数据库实时迁移和数据库实时同步的云服务。用户可通过数据复制服务快速解决多场景下，数据库之间的数据流通问题，以满足数据传输业务需求。数据库复制(CT-DRS)基本能力集计费方式：按需计费，按小时计费使用场景：实时迁移、备份迁移、实时同步、实时灾备迁移方式：全量迁移、全量+增量迁移支持网络：VPC、VPN、专线、公网支持能力：支持对关系型数据库、文档数据库的在线迁移，提供云下数据库迁移上云，跨云平台数据库迁移至天翼云，天翼云VPC网络内数据库迁移，满足多种场景数据库迁移需求。迁移方向：单向、部分双向

3.

4.4天翼云灾备相关产品-云灾备服务41•文件保护智能灾备管理场景•应急可视化管理•切换管理•演练可视化，预案体系化应用保护场景•应用容灾及接管•数据库读写分离•数据库切换融合需求场景•云迁移•云安全•SD-ONE...云灾备私有平台云灾备公有平台云灾备工具产品体系融合支撑产品能力交付能力运营能力运维能力服务能力智能灾备管理•灾备咨询产品•一键式切换产品•业务连续性管理产品•全生命周期平台云灾备平台•定时备份服务•数据容灾服务•多租户灾备管理•多灾备中心灾备管理数据保护场景•海量小文件•数据库定时保护•数据连续保护•云平台保护•灾备数据使用数据保护•定时备份产品•数据容灾产品•副本数据管理•应用容灾产品应急接管•数据库容灾产品•应用容灾产品云灾备服务是基于电信成熟先进的云网融合要客灾备中心和云灾备平台，提供即买即用的云灾备服务，包括数据备份、数据容灾、应用容灾、数据库容灾、数据验证、应急演练、应急切换、灾难恢复等全方位的云网数据安全保障。

3.5云灾备典型场景天翼云云灾备服务-灾备系统典型场景：备份：

1.数据级灾备

2.应用级灾备容灾：

1.异构应用灾备

2.异构数据灾备

3.异构主备

4.异构双活

5.两地三中心

3.

5.1云灾备典型场景-数据级灾备数据级灾备APP应用OSVIS磁盘阵列磁盘阵列磁盘阵列主数据中心备数据中心复制

3.

5.2灾备典型场景-应用级灾备APP应用OSVIS磁盘阵列APP应用OSVIS磁盘阵列应用级灾备应用业务

3.

5.3灾备典型场景-异构应用灾备异构应用灾备系统数据同步请求，写入数据当用户DC应用故障时，天翼云侧应用处理业务，到用户DC访问数据特点：低成本，建设快局域网体验免运维

3.

5.4灾备典型场景-异构数据灾备异构数据灾备特点：低成本，建设快局域网体验免运维

3.

5.5灾备典型场景-异构主备方案异构主备方案特点：异构主备易实施系统高可靠数据库实时同步流量分发流量分发

3.

5.6灾备典型场景-异构双活方案异构双活方案特点：异构主备易实施系统高可靠数据库实时同步流量分发流量分发

3.

5.7灾备典型场景-两地三中心两地三中心

3.6灾备方案适用场景总结灾备方式行业IT能力业务并发RTO/RPO要求距离/时延业务成本DNS能力业务故障切换方式双活•电商•物流•金融有较强的IT维护能力有较大的业务并发量，需要双活负载要求分钟级或秒级故障恢复灾备数据中心之间必须是专有线路且可靠稳定，建议100公里以内，时延小于五毫秒适用于对业务连续性要求高的业务，一般是对外互联网应用。对业务连续性要求较高的企业内部系统也可以采用双活成本较高，客户需要配置GSLB/SLB设备应用系统的访问需要支持DNS方式对于双活来说，故障后业务自动切换，数据库建议手动切换主备•政府•医院IT能力较弱业务并发不大，原来的系统处理无压力故障恢复要求不严苛，在分钟或几小时内灾备数据中心之间必须是专有线路且可靠稳定，建议时延小于20毫秒适用于对业务连续性要求不苛刻的业务系统，一般针对企业内部的业务系统主备面向互联网的应用需要配置GSLB，面向企业内部的系统只需配置SLB设备应用系统访问可以是固定IP方式，也可以是DNS方式故障后业务建议手动切换

3.7天翼云灾备服务优势分析云网融合专项定制端到端的设计交付迁移服务安全可靠•专线能力为数据实时同步提供低延迟、高可靠网络保障；•STN专线连接客户机房与云端:

①100KM时延<5ms;

②IPRAN传输网络承载故障恢复时间<4小时；•DCI直连异地云资源池节点，为异地灾备提供数据传输高可靠保障：

①2000公里时延小于20毫秒，

②100记录光纤直连•专属云：满足核心系统灾备安全要求，计算、存储资源物理隔离，保障应用系统性能和安全隔离要求；•托管区：满足客户定制化安全设备部署需求，在天翼云侧设置托管区，专门用于部署用户特殊无法上云的设备与应用，例如小机、安全网关等；•提供从需求到交付运维的端到端服务，包括：

①需求分析、

②方案设计、

③关键技术验证、

④迁移服务

⑤交付实施、

⑥容灾演练、

⑦交付验收、

⑧运维保障•在线迁移服务，保障生产系统零中断；•小型机X86化服务；•虚拟机迁移服务；•数据迁移服务•较完备的可信与认证；•等保4级、EAL3安全测评、五星级机房；•ISO27001安全管理体系权威认证；•物理安全、技术安全、管理安全多重保障的安全管理机制目录CONTENTS世界触手可及1灾备需求发展趋势及客户分析2灾备基础概念3云灾备关键技术及天翼云灾备产品4天翼云双活典型案例5同城异地双活+容器云容灾实战

4.

1.1典型案例：招商局集团案例简介：招商局采用天翼云搭建的双活容灾架构，建立了高效安全、绿色节能的企业级双活灾备数据中心，打造招商局私有云与天翼云的异构混合云组网，保证了招商局集团生产经营活动的稳定运行。服务历程：招商局集团作为业内首个基于异构云平台之间的双活设计，开创首个大国企私有云与公有云的双活灾备中心实践，以科技创新的优势，走在行业前列。

534.

1.2招商局集团案例背景用户介绍：招商局集团(简称“招商局”)是中央直接管理的一家业务多元的国有综合重要骨干企业，成立距今已一百多年，作为国家型多元化的大型企业集团，总资产达7万多亿人民币，业务包括交通、金融、地产等产业，是企业“大佬”级人物。客户分析：人力案例平台介绍：•招商局原本地自建私有云数据中心•承载的系统包括：OA、财务、人力、邮件以及其他等37套系统•涉及约198台虚拟机、17台物理机•数据库主要为Oracle，部分为Mysql•等等OA财务邮件原本地数据中心（私有云）痛点：•私有云的建设成本太高，建设周期极长，后续运维保障压力大•没有完备的异地备份和容灾措施，一旦发生区域性的意外事件，将导致数据丢失、所有系统无法对外提供服务•金融行业对信息安全、容灾备份能力要求高，急需建立完善有效的灾难恢复机制•小机成本高性能底，需向X86架构迁移，Oracle数据库进行改造迁移，彻底解决DB层虚拟化问题

544.

1.3招商局集团需求与挑战建设目标及挑战：建设目标：异构混合云+异地双活灾备+云迁移混合云管理模式在技术上需要面临在异构混合云、异地双活灾备、云迁移各方面的挑战：私有云与公有云的异构混合云组网的实现数据与应用近零停机和零数据丢失的上云迁移同城应用级双活灾备方案设计和实施双活中心之间数据存储同步问题云平台灾备中心的VPC和各种网络流向设计传统架构向可云化架构的迁移改造(去IOE)等问题客户需求实现7×24小时的“双活”服务，RTO、RPO均小于5分钟小机迁移：零停机和零数据丢失的上云迁移快与省：原来的私有云数据中心规划建设，用去了招商局近2年时间，仅一期就投资了1亿元，急需建立完善有效、优化成本的灾难恢复机制六条铁律：可定制、可服务、可连接、可信、可靠、可扩好运维：后期运维保障难度低可拓展：未来能够支持“两地三活”，能够通过国际网络为招商局的“一带一路”战略服务具备自主知识产权和自有核心技术55天翼云为招商局提供专属云、专用物理机、虚拟私有云、STN云专线、云托管、系统迁移、去小机等服务，规划双活网络方案，实现天翼云与招商局集团蛇口中心私有云专线双链路互联，组成双云数据中心：

4.

1.4招商局集团解决方案与技术架构天翼云

3.0时期建设方案正常数据链路情况故障时数据链路蛇口数据中心应用服务器数据库服务器存储阵列ECSECSASECSECSASECSECSWeb服务器应用服务器数据库服务器SlaveWeb服务器VPC生产数据中心......EVSEVS云专线数据库MasterELB主备容灾天翼云50%DNS50%双数据中心高速互联，资源互为备份，实现为客户全部的核心系统提供双活容灾当Web、APP或DB层出现故障时，访问流量会自动切换到灾备节点RTO/RPO均小于5分钟，确保招商局综合管控系统可持续稳定、安全的运行天翼云还为邮件系统提供200M互联网带宽，通过天翼云防火墙以及虚拟私有云提供安全可靠的网络访问控制，保障邮件系统与其他应用系统时刻保持网络隔离，提高安全性去小型机、平滑迁移、在线迁移近零停机，实现了跨数据中心系统虚拟化和数据库的无缝对接，完成异构云平台间的迁移

564.

1.5招商局集团项目价值项目价值：该项目是天翼云首个基于混合云架构的成果案例，仅在四个月内的项目期内，天翼云完成了专线开通、系统迁移、去小型机、托管区设计、应用双活等，成功为招商局集团节省60%的成本树标杆：业内首个基于异构云平台之间的双活设计，开创了首个大国企私有云与公有云的双活灾备中心实践。获得了市场的高度认可，在与天翼云的合作下，此次招商局更是作为混合云的标杆型案例，成为唯一一家成功入选《2017年混合云白皮书》的央企案例提高了招商局生产业务的连续性和降低IT运营成本，提供了一个高安全、高可用、高稳定、绿色节能环保的企业级双活灾备数据中心客户评价天翼云：“六可一省一快”六可：可定制：有定制的能力可服务：有快速的本土现场服务的团队和能力、综合解决方案和服务的能力可连接：云网融合能力，具备丰富的网络资源可信：一是平台可信，二是安全（数据的绝对保密性）可靠：IDC数据中心的运营管理达到五星级的运维保障标准和能力可扩：根据需要，可随时扩展资源一省：节约成本一快：有随叫随有的反应速度5701设计需求招商集团目前针对部分业务系统已经建成了本地双活灾备体系，但是经过近几年的发展，有如下变化：

1.新增多个核心及次关键业务系统；

2.对于未做双活灾备的业务系统，存在数据丢失和业务中断的风险；

3.缺乏可视化自动切换灾备管理平台02实施部署需求通过咨询规划，梳理出各业务的RPO/RTO,灾难恢复策略，业务系统的重要性分级，双中心技术方案等；将招商局集团全部业务系统在招商云与天翼云之间进行双活中心的重新规划，建设03灾难恢复预案需求应急响应预案和灾难恢复预案的编制；推演灾难场景，制定切换策略，编写切换手册；协助完成灾难恢复组织架构、流程、人员设置。04灾备演练及培训需求灾备子系统验证；灾备环境整体测试；灾备切换演练；自动化灾备演练工具；知识转移和培训。05灾备运维管理制度需求生产中心和灾备中心的良好互动机制：版本升级、补丁修复、配置变更；制订灾难备份中心运行管理制度：总则、分项、罚则。

4.

1.6招商局集团容灾管理体系2022新需求分析

4.

1.7招商局集团解决方案与技术架构2022建设方案DNS流量0%异地容灾数据中心解决方案•

1、生产数据中心和容灾中心分别部署在2个不同Region。同城双AZ，异地容灾中心单AZ。•

2、在生产和容灾中心分别部署云数据库实例，同城跨AZ使用云数据库主备模式，跨Region使用数据库复制服务实现云数据库复制。•

3、生产和容灾中心产生的应用配置、日志、备份等，通用虚拟机高可用服务实现切换•

4、生产站点某个AZ故障时，通过数据库复制服务将应用切换到另一个AZ，数据库主备切换。•

5、针对异地虚拟机实例，通过字节级异步复制服务来实现。•

6、针对数据库及数据采用异地备份；•

7、针对关键数据的任意时间点恢复采用CDP实现，防止数据误删除等•

8、针对平台招商云与灾备节点的主备，采用高可用服务，以及数据库复制服务来实现•

9、Region1故障时，切换数据库的主备状态，然后将DNS授权修改为生产站点0%，容灾站点为100%。•10、生产Region修复后，数据库切换回主库，DNS切换回主站点Internet/专线AZ1AZ2ECMECMECSECMECMECSDNS流量100%全局负载均衡备主地域1数据库同步ECMECMECS全局负载均衡云数据库实例备地域2数据库同步同城双活生产数据中心主机高可用专线解决方案主机高可用平台应用主平台数据库平台应用备平台数据库数据库容灾主机高可用应用层主机层数据库层平台层两地三中心容灾技术说明图容灾平台AZ3天翼云正常情况链路故障时链路

1、提供业界最高标准的业务连续性和数据可用性保障，在发生超大规模地域级自然灾害的时候都能保护数据和业务；

2、理论可达容灾六级标准：RPO=0，RTO≤2分钟；方案特点

4.

1.8招商局集团项目价值中国电信携手招商局集团共创业界一流的全栈云容灾体系项目规模1388万，创新打造“国资云异构云容灾解决方案“落地新标杆！60携手招商局集团建设容灾管理体系和基础设施，联合打造招商局两地三中心云容灾环境，将招商局集团部分核心应用迁移上容灾环境，后续扩展到招商局各地公司核心系统容灾化改造，为二十大及招商局150周年献礼；

4.

2.1典型案例：某市儿童医院双活项目客户IT现状及痛点：•院内有主备数据中心，IBM小型机维护成本高，物理机和私有云并存；•医疗信息化及信息化辅助系统81个系统；•采用了Oracle（7套）、Mysql及MicrosoftSQLServer（9套）三种数据库•希望把机房腾出来作为病房客户云灾备的期望：•系统更可靠，实现数据零丢失、故障自愈；•业务上线速度更快，数月缩短为数小时；•租赁服务维护成本更低；•弹性架构自动扩缩容，系统扩容成本更低

614.

2.2某市儿童医院双活项目：解决方案及建设目标医院的IT设施可作为一种服务，提供给患者，产生更大的价值建设目标：用云端托管方式建设医疗云，实现高可用，不中断，运营模式创新机房网络环境高可用核心业务连续不中断全量业务数据零丢失业务快速上线部署信息安全三级等保云灾备解决方案两地三中心，应用双活主机房私有云+天翼云灾备中心+千兆专线本地不留机房云专线两地三中心，应用双活天翼云备数据中心天翼云主数据中心儿童医院园区数据中心数字化医院应用系统HIS系统PACS系统EMR系统...LIS系统RIS系统电信天翼云助力该儿童医院成功冲三甲！62需求：

1.双机：相同应用在两中心之间构建HA，保证双机在各中心同时运行，并在故障时实现切换

2.流量：负载分担，业务A流量引导到数据中心A，业务B流量引导到数据中心B

3.同步：两个数据中心数据保持写同步

4.延时：两中心数据延迟不超过10ms

5.距离：为了保持10ms延迟时间，电信根据实际测试，选择本市A机房与B机房，通过电信主干裸光纤互连，可保证80KM以内的距离，保证10ms延时，满足双活架构建设需要

4.

2.3儿童医院双活设计：业务组网模型设计医生工作站数据中心A应用A应用B双活双活数据中心B应用A应用B63前端网络层：•不同数控中心的前端网络通过IP技术实现互联，儿童医院工作客户通过前端网络访问各数据中心•当主数据中心发生灾难时，前端网络快速收敛，使得客户端访问灾备中心保障业务连续DCI层：•在不同的数据中心网络接入层，通过SDN+VxLAN构建一个跨数据中心的大二层网络，以满足服务器集群或虚拟机动态迁移等场景存储层：•通过两个机房的传输链路实现主中心和灾备中心间磁盘阵列的数据复制技术，并结合自带的双活功能，实现存储层双活

4.

2.4儿童医院双活设计：网络组网模型设计业务系统在两个数据中心都能被访问到儿童医院园区网络存储ASANSAN互联SDN+VxLANDCI互联SAN存储B

644.

2.5儿童医院双活项目网络高可用架构某市电信双链路裸光纤安全防护二层互联健康探测存储扩展儿童医院某市电信双链路裸光纤入口选择

654.

2.6儿童医院双活项目出口网络高可用

664.

2.7儿童医院双活项目备份方案数据备份：•备份数据涉及操作系统、业务数据和虚拟机映像文件三方面•主备数据中心之间的备份，还将其中一份数据备份至儿童医院本地，实现三中心的数据备份数据库备份：•将数据库的结构和数据导出为一个或多个文件，如Mysql的mysqldump，SQLServer的备份维护计划，Oracle数据库的expdp，RMAN备份等，数据级别的备份，PRO和RTO较长•数据库热备集群RAC和数据库复制DataGuard备份对象备份类型备份服务策略云主机虚拟机备份√每周六晚上8：00全备份；其他时间每日晚上8：00增量备份，保留一周云主机高可用√云数据库逻辑备份√每周六晚上8：00全备份；其他时间每日晚上8：00增量备份，保留一周热备（单点故障）√RAC：所有节点均处于活动状态，负载均衡，提供故障容错和无缝切换数据库复制（源数据库软件或共享存储故障）√DataGuard：Oracle自带的数据同步功能，将日志文件从源数据库传输到目标数据库，保持同步67目录CONTENTS世界触手可及1灾备需求发展趋势及客户分析2灾备基础概念3云灾备关键技术及天翼云灾备产品4天翼云双活典型案例5同城异地双活+容器化云上多活实战典型应用如何快速实现迁移上云？利用天翼云公有云产品，如何设计异地双活容灾架构并快速实战实现？一起动手吧！5典型应用容器化+同城异地双活实战练习要求(练习进度体现需求演变)：

1.单机部署Web应用：使用单节点CT-ECS部署Web网站，在同节点ECS自建MYSQL数据库提供服务；

2.双节点部署应用双活：使用ECS、CT-ELB等产品实现服务应用层同城双活，使用云数据库CT-RDSMYSQL实现数据库层同城跨AZ主备容灾，使用云主机备份实现主机状态及存储层硬盘备份，并进行灾难演练；

3.应用容器化：了解如何对网站进行容器化改造、镜像打包方法等；

4.容器云环境下应用多活容灾：完成使用CT-CCE及镜像服务等，在容器云环境下部署网站同城多活容灾，数据库层实现跨AZ主备，跨Region异地灾备数据中心，并进行灾难演练；异地多活695练习使用WEB应用运行拓扑70WEB服务器PHP文件网页文件(html/js/css)PHP解析器HTTP请求DBDBfastcgi接口经典PHPWEB程序运行拓扑网站源文件源网站网站程序文件组成：•index.html：首页•database.php：php程序文件，用于连接数据库，进行数据查询和呈现，需要php程序进行解释•css目录：保存了网站所需的样式表（.css）文件，用于页面展示•images目录：保存了网站需要展示的图片文件•js目录：保存了网页所需的JavaScript脚本（.js）文件，用于为页面添加各种功能•upload目录，一般用于保存用户上传的内容练习使用Web程序分析网站运行环境依赖：httpd，phpphp-cliphp-commonphp-mysqlphp-pdo，mysql“LAMP”：Linux+Apache+Mysql+PHP

5.1单机部署WEB应用Web服务器VPC数据库跳板机通过公网弹性IP远程桌面至跳板机...单机同时提供web应用服务与数据库所需天翼云资源：Linux（CentOS

7.4及以上）云主机*1Windows云主机*1弹性IP*2各云主机需部署：Linux主机Web-01：安装常用工具、部署httpdphpphp-cliphp-commonphp-mysqlphp-pdo，mysql等web程序运行环境依赖，上传Web程序文件，导入程序数据文件至本地数据库Windows云主机：无需部署，使用自带浏览器访问验证即可

715.1部署流程准备工作购买Linux云主机基础软件安装应用软件安装数据库准备与修改配置服务提供

721.创建VPC、安全组（Sys-FullAccess），购买Windows跳板机并绑定弹性公网IP

2.购买与跳板机在同一网络环境的Linux系统云主机Web-01一台，并绑定弹性公网IP

3.连接机器，安装基础工具软件

4.搭建应用运行所需环境，安装运行所需依赖

5.安装数据库软件、导入程序所需的Sql库文件，并修改网站数据库连接配置

6.访问Web页面验证

5.

1.1练习准备工作资源池选择<苏州>（苏州有多AZ可供灵活选择）创建VPC、安全组和跳板机：步骤如下：

1.创建虚拟私有云-VPC

2.创建网络安全组策略：Sys-FullAccess

3.创建Windows云主机：2C4G，windows2016，Sys-FullAccess

4.通过页面远程登录至Windows云主机73安装xshell，学员实操电脑需安装用于连接Linux服务器的工具软件，如果已经装有xshell、CRT或moba其中任何一个则无需重复安装，没有的学员可使用基地的xshell安装包进行安装。

5.

1.2准备Linux云主机申请云主机：步骤如下：

1.与创建Windows跳板机流程一致，资源选最小量1C1G即可

2.镜像CentOS

7.664位

3.VPC及安全组策略与跳板机保持一致，选择Sys-FullAccess

4.绑定弹性公网IP

745.

1.3安装并启动HTTP

1.安装，启动和验证apache：#yum-yinstallhttpd#systemctlstarthttpd&&systemctlenablehttpd#curl

127.0.0.1:80#确认环境已启用

755.

1.4安装PHP及相关依赖，上传网站源文件

1.安装PHP及相关依赖：#yum-yinstallphpphp-cliphp-commonphp-mysqlphp-pdo#php-h#systemctlrestarthttpd

2.创建工作目录，上传网站源文件并拷贝至Webserver站点目录/var/www/html：#mkdir/root/workdir#cd/root/workdir#rz#上传网站源文件#unzipwen.zip#cp-rhtml/*/var/www/html（此时已经能访问网站静态页面）

765.

1.5安装数据库，导入程序数据库SQL文件

1.安装软件，启动数据库#yum-yinstallmariadbmariadb-server#systemctlstartmariadb&&systemctlenablemariadb

2.初始化数据库，设置用户名，密码，远程访问权限等#mysql_secure_installation（按照提示进行配置即可）

3.导入文件中的数据库#mysql-uroot-pxxxxx>createdatabasehr_db;>usehr_db;>sourcehr_db.sql;>showtables;

775.

1.6修改网站数据库配置

1.进入站点目录，修改database.php中的数据库连接配置：#cd/var/www/html#vimdatabase.php78数据库服务器IP数据库服务器用户名数据库服务器密码使用的DB名称

785.

1.7访问网站•通过跳板机中的浏览器访问网站动静态页面

795.2云主机方式部署同城双活80

1.要求：双节点部署应用双活——初步想法：使用ECS、CT-ELB等产品实现服务应用层同城双活，使用云数据库CT-RDSMYSQL实现数据库层同城跨AZ主备容灾，使用云主机备份实现主机状态及存储层硬盘备份，并进行灾难演练；

2.方案设计？

5.2传统方式部署同城双活需新增天翼云资源：Linux（CentOS

7.4及以上）云主机+1CT-RDSFORMYSQL主备实例*1CT-ELB*1弹性IP+1需部署：Linux主机Web-01/02：安装常用工具、部署httpd、安装php等web程序运行依赖，上传Web程序文件，并部署在站点目录CT-ELB：配置负载均衡云数据库：导入数据库文件81Web应用服务器Web-01VPC跳板机通过公网弹性IP远程桌面至跳板机Web应用服务器Web-02ELB负载均衡DB备AZ2DB主AZ1主库故障时备库自动切换为主

5.2部署流程创建云数据库CT-RDS，并导入数据库创建容灾云主机Web-02创建、配置负载均衡CT-ELB验证服务整机镜像备份灾难演练

821.购买数据库主备实例并绑定弹性公网IP，导入数据库，并修改程序源文件database.php中的数据库连接配置

2.使用Web-01的云主机整机镜像创建新的Web-02，相关配置一致即可（参照操作手册）

3.创建负载均衡，并配置后端主机，负载到Web-01与Web-02的80端口

4.验证Web-02是否可以访问，再验证使用负载均衡入口进行访问，观察负载均衡现象

5.对云主机进行整机镜像备份

6.在Web-01与Web-02中任选一台云主机强制关机，再次访问负载均衡入口验证是否可访问；使用整机镜像创建新的Web应用服务器，在ELB中增加流量负载后端，观察是否能够正常承载流量，提供服务

5.

2.1准备数据库购买数据库实例：步骤如下（可参考右侧截图配置）：

1.购买数据库实例，主备分别放在不同可用区

2.性能、存储等选最低配置

3.VPC及安全组策略与跳板机保持一致，选择Sys-FullAccess

4.绑定弹性公网IP后，修改Web-01中的网站数据库配置导入数据库数据：使用任一台Web应用服务器连接数据库，将数据库Sql库文件导入：83#mysql-uroot-pxxxxx-hx.x.x.x>createdatabasehd_db;>usehr_db;>sourcehr_db.sql;>showtables;

5.

2.2准备Linux云主机并部署网站创建Web-01的云主机整机镜像备份：使用【镜像服务】创建上一练习中的Web-041整机镜像84创建应用层灾备云主机Web-bak：步骤如下：

1.使用已创建好的Web-041整机镜像申请主机Web-bak-0

415.

2.3验证Web-bak应用层灾备服务可用使用跳板机浏览器访问Web-bak的网站静态、动态页面，进行验证：

855.

2.3为AZ1和AZ2的Web应用服务器配置负载均衡创建弹性负载均衡，并绑定云主机：步骤如下：

1.创建弹性负载均衡

2.配置监听器

3.添加后端主机组-使用已有云主机、批量添加端口填写80，刚添加好后健康检查结果显示异常，暂不用理会，继续后面的步骤即可，稍后即会恢复正常

4.添加监听器

5.通过跳板机浏览器进行访问验证

865.

2.4通过负载均衡地址，进行访问验证•通过跳板机中的浏览器访问网站动静态页面

875.

2.5灾难演练应用层：•对任一节点进行强制关机：已关机节点部署的Web无法访问使用负载均衡弹性IP访问网站，验证仍可访问，流量都转发到备节点数据库层：对数据库进行主备切换，验证网站数据页面仍提供服务88WEB服务器PHP文件网页文件(html/js/css)PHP解析器HTTP请求DBDBfastcgi接口经典PHPWEB程序运行拓扑网站源文件源网站网站程序文件组成：•index.html：首页•database.php：php程序文件，用于连接数据库，进行数据查询和呈现，需要php程序进行解释•css目录：保存了网站所需的样式表（.css）文件，用于页面展示•images目录：保存了网站需要展示的图片文件•js目录：保存了网页所需的JavaScript脚本（.js）文件，用于为页面添加各种功能•upload目录，一般用于保存用户上传的内容应用容器化练习Web程序分析

5.

3.1典型WEB程序容器化方案网站架构分析通过上面的分析，可以看出，目前需要迁移的内容包括：

1、静态文件（.html文件，图片文件，css文件，js文件等）的发布；

2、动态网页文件（.php文件）发布；

3、数据库发布（主要提供供php等访问的数据库服务）。

895.

3.2典型WEB程序容器化程序改造修改网页的内容，使之适应在容器环境下运行编辑database.php文件，将数据库连接参数用环境变量代替:运行镜像时，将数据库配置作为环境变量写入即可#dockerrun-d-p8080:80apache-php:v8-e"PHP_ENV_SQL_IP=

192.

168.

3.121"\-e"PHP_ENV_SQL_USERNAME=root"\-e"PHP_ENV_SQL_PASSWORD=123456"\-e"PHP_ENV_SQL_DBNAME=hr_db"\myphp:v

15.

3.3应用容器化方法系统软件Web，PHP，Java，Python基础操作系统CENTOS，UBUNTU应用程序PY/PHP/JAR/WAR网页（可能需要改造）配置文件，启动命令Dockerfiledockerbulild•FROM•RUN•CP/ADD•CMD•......镜像多次运行dockerrun容器环境变量，密钥参数，挂载卷容器容器一次构建镜像仓库存储拉取

915.

3.4典型WEB程序容器化镜像打包

1.编写Dockerfile文件

2.创建httpd-foreground.sh，容器内运行文件

3.镜像打包-dockerbuild命令#使用centos

7.6基础镜像开始构建FROMcentos:

7.

6.1810#调整安装源RUNyumcleanallRUNrpm--rebuilddb#安装HTTP、PHPRUNyum-yinstallhttpdRUNyum-yinstallphpphp-cliphp-commonphp-mysqlphp-pdo#拷贝网站文件拷贝到容器内ADD./html/var/www/html#拷贝容器启动文件到容器内，并更改为可执行文件COPYhttpd-foreground.sh/usr/local/sbin/RUNchmodu+x/usr/local/sbin/httpd-foreground.sh#对外暴露80端口EXPOSE80#容器启动时执行，将HTTP进程作为容器第一个进程执行CMD["/usr/local/sbin/httpd-foreground.sh"]Dockefile样例！#!/bin/bashset-e/usr/sbin/httpd-DFOREGROUND

924.运行镜像时，将数据库配置作为环境变量写入#dockerrun-d-p8080:80apache-php:v8-e"PHP_ENV_SQL_IP=

192.

168.

3.121"\-e"PHP_ENV_SQL_USERNAME=root"\-e"PHP_ENV_SQL_PASSWORD=123456"\-e"PHP_ENV_SQL_DBNAME=hr_db"\myphp:v

15.

4.1异地双活容灾实操云容灾需求：云上多活、数据备份：完成使用CT-CCE进行网站的异地双活容灾架构设计与实现，要求应用层实现同城多活、数据库层实现跨AZ主备，跨Region异地灾备；在云时代，如何动手实现一个典型场景应用上云？云化架构下，双活容灾架构应该如何设计，有何优势？云硬盘云硬盘备份云数据库CT-DRS数据库复制实时同步服务云专线SLB/GLSBCDN加速云间高速异地多活

935.

4.2云化环境及数据库设计

1.云化环境：订购三控制节点（高可用）CCE集群，node节点在AZ

1、AZ

2、AZ3中各配置一台，通过节点亲和性将pod分散在不同节点，实现让服务副本运行在不同AZ的云主机之上，实现应用层容灾要求

2.数据库：使用主备跨AZ数据库实例实现同城容灾需求，并在另一Region部署数据库灾备实例，两处通过数据库复制服务实现异地Region数据备份；<苏州合营池>NodeAZ1NodeAZ3NodeAZ2三AZ高可用CT-CCE集群使用天翼云数据库复制服务，对数据库进行定期全备/增备Region1DB备AZ2DB主AZ1主库故障时备库自动切换为主Region2DB主AZ1DBAZ2主库故障时备库自动切换为主CT-DRS94Master节点3AZ高可用Node节点3AZ高可用

5.

4.3整体架构设计SERVICE（集群内部访问或外部访问，4层负载均衡）客户端SERVICE（集群内部访问或外部访问，4层负载均衡）Deployment(replicaset)副本控制Deployment(replicaset)副本控制苏州PodPod···AZ1PodPod···AZ2PodPod···AZ3Region1DB备AZ2DB主AZ1主库故障时备库自动切换为主Region2DB主AZ1DBAZ2主库故障时备库自动切换为主CT-DRS服务实例运行在不同AZ节点，且发生故障时会自动在其他可用节点迅速重新拉起新的Pod配置LoadBalancer，弹性IP访问同城数据中心发生灾难时，手动切换数据库连接

5.

4.4部署流程购买CT-CCE集群分别购买不同可用区Node节点准备数据库上传准备好的镜像文件部署Deployment及Service服务提供

961.购买CCE集群，控制节点高可用，网络策略需与跳板机保持一致

2.购买AZ

1、AZ

2、AZ3的node节点各一台，网络策略与跳板机保持一致

4.通过容器镜像服务上传已准备好的镜像文件

5.部署无状态服务Deployment，注意需填入数据库连接配置的环境变量、部署LoadBalancer类型的Service，将流量代理到Deployment

3.准备数据库环境，可直接复用练习二中的主备数据库实例

6.访问Web页面验证

5.

4.4CT-CCE环境说明购买CT-CCE集群，添加AZ1节点后创建集群，集群创建完毕后添加AZ2节点、AZ3节点，使用windows跳板机（复用练习一跳板机即可）进行最后的验证

975.

4.5上传镜像文件•通过天翼云CCE页面的“容器镜像服务”上传准备好的镜像文件

5.

4.6部署Deployment•通过天翼云CCE页面-工作负载-无状态应用-进行Deployment的部署•过程中配置可用区亲和性、健康检查•以环境变量的形式载入数据库连接配置

5.

4.7部署Service•部署无状态应用Deployment后选择Service-LoadBalancer类型进行部署•选择上一步部署好的Deployment进行代理

5.

4.8通过页面查看POD副本运行的节点情况•通过CCE内部策略算法调度到最优节点•如有节点丢失（故障灾难导致宕机等），POD将会在其他节点自动拉起

5.

4.9通过Service绑定的弹性IP访问页面•通过跳板机浏览器访问网站静态页面、动态页面进行验证10

25.5应用层双活故障模拟演练

2.模拟AZ可用区故障：对Region1中的AZ1或AZ2所有云主机进行强制关机，观察验证：访问服务验证，正常；通过集群查询POD运行情况，其他区域POD正常运行；

1.模拟单节点故障：随机对一台node节点进行强制关机，观察验证：访问服务验证，正常；通过集群查询POD运行情况，其他区域POD正常运行；10

31.模拟后端Web服务程序单点故障：随机对单个Pod副本直接删除，观察验证：访问服务验证，正常；通过集群查询POD运行情况，其他区域POD正常运行，因关机宕掉的POD已重启并自动调度到其他节点；

5.6课后自主完成-跨Region灾备数据中心建设、并切换验证分别在两个城市资源池购买CT-RDSMYSQL实例：

1.在另一城市创建虚拟私有云，并购买RDS实例，作为灾备数据中心

2.建立苏州主数据中心到灾备数据库的数据复制服务，进行数据复制同步

3.灾难演练（更换数据库连接配置，访问网站动态页面进行验证）10

45.6数据库跨AZ主备、Region故障数据恢复模拟演练

1.模拟数据库主库故障：在页面执行主备切换，观察验证：主备成功切换；访问服务验证，动态页面数据正常；

2.模拟在用库整个Region故障：直接更新Deployment中数据库连接配置为灾备中心数据库，观察验证：访问服务验证，动态页面数据正常；检查数据库数据，正常；10

55.7容器云CCE部署优势部署实施简单一键水平扩缩容平稳滚动更新快速恢复DevOps体系下，运维变得简单可规避多个传统容灾模式下的痛点回顾与探讨

1.传统方式主机部署服务，容灾建设优势？劣势？

2.容器云环境容灾优势？

3.你认为以上两种同城双活架构各具有哪些优点？存在哪些缺点？

4.与其他云服务商相比，天翼云优势有哪些？107课程开发团队张姣王蓉张逍遥庄甲升韩璐中国电信灾备服务资质：行业前

三、专灾备二十载

